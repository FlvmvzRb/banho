<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda: Banho e Tosa</title>

    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts: Inter (para o corpo) e Nunito (para o título) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Nunito:wght@800;900&display=swap" rel="stylesheet">
    
    <!-- Custom CSS for Theme and Scrollbars -->
    <style>
        /* Define custom color properties for easy theme management */
        :root {
            --color-primary-base: #7DFABE; /* Verde Borda (Novo) */
            --color-primary-light: #f2e8fa; /* Lilás Claro (Novo) */
            --color-secondary-purple-start: #c263f9; /* Roxo/Lilás Inicial (Novo) */
            --color-secondary-purple-end: #8f1fcf; /* Roxo/Lilás Final (Novo) */
            --color-primary-dark-text: #4A5568; /* Gray-700 */
            --color-finalized-bg: #D1FAE5; /* Green-100 */
            --color-finalized-border: #6EE7B7; /* Green-300 */
            --color-finalized-dark-bg: #A7F3D0; /* Green-200 */
            --color-finalized-dark-border: #34D399; /* Green-400 */
            --color-arrived-bg: #E0F2FE; /* Sky-100 */
            --color-arrived-border: #7DD3FC; /* Sky-300 */
            --color-requested-bg: #FEE2E2; /* Red-100 */
            --color-requested-border: #F87171; /* Red-400 */
            --color-attention-orange-bg: #FFF7ED; /* Orange-100 */
            --color-attention-orange-border: #FB923C; /* Orange-400 */
            --color-tosa-bg: #FFFFCC; /* Amarelo-Bege (Custom) */
            --color-tosa-border: #F0E68C; /* Khaki (Borda correspondente) */
            --color-taxidog-bg: #D1D5DB; /* Gray-300 */
            --color-taxidog-border: #9CA3AF; /* Gray-400 */
            --color-accent-gold: #F59E0B; /* Amber-500 */
            --color-approved-border: #22C55E; /* green-500 */
            --color-denied-border: #EF4444; /* red-500 */
        }

        /* Apply the main font and color to the entire application */
        body {
            font-family: 'Inter', sans-serif; /* Fonte padrão revertida para Inter */
            background-color: #F7FAFC; /* Gray-100 */
            color: #4A5568; /* Cor do texto principal revertida para cinza */
        }

        /* MODIFICADO: Estilo específico para o título principal */
        h1.page-title {
            font-family: 'Nunito', sans-serif; /* Fonte arredondada apenas para o título */
            color: var(--color-secondary-purple-end); /* Cor roxa para o título */
        }
        
        /* Custom scrollbar styling for a more integrated look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-secondary-purple-start);
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--color-secondary-purple-end);
        }

        /* Focus styles for better accessibility and user experience */
        input:focus, select:focus, textarea:focus, button:focus {
            outline: 2px solid var(--color-primary-base) !important;
            outline-offset: 2px;
        }

        /* Gradient background classes */
        .gradient-purple-to-dark-purple {
            background-image: linear-gradient(to right, var(--color-secondary-purple-start), var(--color-secondary-purple-end));
        }

        /* Background for cards based on status */
        .finalized-green-bg { background-color: var(--color-finalized-bg); border-color: var(--color-finalized-border); }
        .finalized-dark-green-bg { background-color: var(--color-finalized-dark-bg); border-color: var(--color-finalized-dark-border); }
        .arrived-blue-bg { background-color: var(--color-arrived-bg); border-color: var(--color-arrived-border); }
        .requested-red-bg { background-color: var(--color-requested-bg); border-color: var(--color-requested-border); }
        .attention-orange-bg { background-color: var(--color-attention-orange-bg); border-color: var(--color-attention-orange-border); }
        .tosa-yellow-bg { background-color: var(--color-tosa-bg); border-color: var(--color-tosa-border); }
        .taxidog-dark-bg { background-color: var(--color-taxidog-bg); border-color: var(--color-taxidog-border); }
        
        /* Custom calendar styles */
        .calendar-day { transition: all 0.2s ease-in-out; }
        .calendar-day.selected { background-color: var(--color-primary-base); color: white; border-radius: 50%; font-weight: bold; }
        .calendar-day:not(.disabled):hover { background-color: var(--color-secondary-purple-start); color: white; border-radius: 50%; }
        
        /* Virtual Keyboard Styles */
        #virtual-keyboard-container { transition: transform 0.3s ease-in-out; z-index: 10001; }
        .keyboard-key { transition: background-color: 0.1s ease; }
        .keyboard-key:active { background-color: var(--color-primary-base); color: white; }
        .keyboard-key.active-special { background-color: var(--color-secondary-purple-start); color: white; }
        
        /* Remessa (Batch) Selection Styles */
        .selected-for-remessa { border-color: var(--color-primary-base) !important; background-color: var(--color-primary-light); box-shadow: 0 0 0 2px var(--color-primary-base); }
        
        /* Compact view card styling */
        .compact-card { cursor: pointer; }
        .compact-card:not(.expanded) { height: 120px; width: 120px; }
        .compact-card.expanded { grid-column: span 2; z-index: 10; }
        @media (min-width: 640px) { .compact-card.expanded { grid-column: span 2 / span 2; } }
        @media (min-width: 1024px) { .compact-card.expanded { grid-column: span 3 / span 3; } }

        /* Styles for Info Modal Content */
        .prose h4 { font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.5rem; color: var(--color-primary-dark-text); border-bottom: 1px solid #ddd; padding-bottom: 0.25rem; }
        .prose h5 { font-size: 1.1rem; font-weight: bold; margin-top: 1.2rem; margin-bottom: 0.5rem; color: #4A5568; }
        .prose p { margin-bottom: 1rem; line-height: 1.6; }
        .prose ul { list-style-position: inside; list-style-type: disc; margin-left: 1rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.5rem; }
        .prose strong { color: #2D3748; }

        /* Custom style for Sala VIP label */
        label[for*="service-sala-vip"] { color: #FBBF24; font-weight: 700; text-shadow: 0px 1px 2px rgba(0,0,0,0.5); transition: color 0.2s; }
        label[for*="service-sala-vip"]:hover { color: var(--color-accent-gold); }

        /* Sala VIP Tab Button Style */
        #sala-vip-tab-btn { color: var(--color-accent-gold); border-color: var(--color-accent-gold); }
        #sala-vip-tab-btn.gradient-purple-to-dark-purple, 
        #sala-vip-tab-btn:hover { color: white; border-color: var(--color-primary-base); }
        
        /* Sticky header styles */
        .sticky-header {
            position: sticky; top: -1px; z-index: 20; background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px); padding-top: 1.5rem; padding-bottom: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-left: -1.5rem; margin-right: -1.5rem; padding-left: 1.5rem; padding-right: 1.5rem;
        }

        /* Request status borders */
        .approved-border { border-color: var(--color-approved-border) !important; border-width: 2px; box-shadow: 0 0 8px var(--color-approved-border); }
        .denied-border { border-color: var(--color-denied-border) !important; border-width: 2px; box-shadow: 0 0 8px var(--color-denied-border); }

        /* MODIFICADO: Estilo para Checkbox */
        input[type="checkbox"] {
            accent-color: var(--color-primary-base);
        }
    </style>
</head>
<body class="bg-gray-50 pb-64">

    <!-- Main Application Container -->
    <div id="app-container" class="container mx-auto p-4 md:p-6 lg:p-8">
        
        <!-- Header -->
        <header class="text-center mb-6">
            <!-- MODIFICADO: Adicionada classe 'page-title' para aplicar estilo específico -->
            <h1 class="page-title text-4xl font-extrabold">Agenda: Banho e Tosa</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1"></p>
        </header>

        <!-- Tab Navigation -->
        <nav class="flex justify-center flex-wrap gap-2 mb-6 no-print">
            <button id="reception-tab-btn" class="tab-button flex items-center gap-2 px-6 py-2 rounded-md text-white font-semibold shadow-md transform transition-transform duration-200 hover:scale-105 gradient-purple-to-dark-purple border-2 border-[var(--color-primary-base)]" data-tab="reception-tab-content"><i class="ph-bold ph-desktop"></i>Recepção</button>
            <button id="grooming-tab-btn" class="tab-button flex items-center gap-2 px-6 py-2 rounded-md text-white font-semibold shadow-md transform transition-transform duration-200 hover:scale-105 bg-gray-400 border-2 border-[var(--color-primary-base)]" data-tab="grooming-tab-content"><i class="ph-bold ph-scissors"></i>Banho e Tosa</button>
            <button id="taxi-dog-tab-btn" class="tab-button flex items-center gap-2 px-6 py-2 rounded-md text-white font-semibold shadow-md transform transition-transform duration-200 hover:scale-105 bg-gray-400 border-2 border-[var(--color-primary-base)]" data-tab="taxi-dog-monitoring-tab-content"><i class="ph-bold ph-car"></i>Taxi Dog</button>
            <button id="sala-vip-tab-btn" class="tab-button flex items-center gap-2 px-6 py-2 rounded-md bg-amber-50 font-semibold shadow-md transform transition-transform duration-200 hover:scale-105 border-2" data-tab="sala-vip-tab-content"><i class="ph-bold ph-crown"></i>Sala VIP</button>
        </nav>
        
        <!-- Main Content Area (Form + Lists) -->
        <main class="flex flex-col lg:flex-row gap-6">

            <!-- Left Sidebar: New Appointment Form -->
            <aside id="appointment-aside" class="w-full lg:w-1/3 p-6 rounded-lg shadow-lg text-white gradient-purple-to-dark-purple border-2 border-[var(--color-primary-base)] no-print transition-all duration-300">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2 flex items-center gap-2"><i class="ph-bold ph-calendar-plus"></i>Novo Agendamento</h2>
                <form id="appointment-form" class="space-y-4">
                    <!-- Tutor and Pet Info -->
                    <div>
                        <label for="tutor-name" class="block text-sm font-medium">Nome do Tutor</label>
                        <input type="text" id="tutor-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:ring-teal-500 focus:border-teal-500 text-gray-900" required>
                    </div>
                    <div>
                        <label for="pet-name" class="block text-sm font-medium">Nome do Pet</label>
                        <input type="text" id="pet-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900" required>
                    </div>
                    <div>
                        <label for="pet-breed" class="block text-sm font-medium">Raça do Pet</label>
                        <input type="text" id="pet-breed" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900" required>
                    </div>
                    <div>
                        <label for="appointment-datetime" class="block text-sm font-medium">Data e Hora (para 1º agendamento)</label>
                        <input type="datetime-local" id="appointment-datetime" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900" required>
                    </div>
                    
                    <!-- Services Section Wrapper (for cloning) -->
                    <div id="main-form-services-wrapper">
                        <div class="pt-2">
                            <label class="block text-sm font-bold mb-2">Serviços Solicitados</label>
                            <div id="services-checkboxes" class="grid grid-cols-2 gap-x-4 gap-y-2">
                                <div class="flex items-center"><input type="checkbox" id="service-banho" value="Banho" class="h-4 w-4 rounded"><label for="service-banho" class="ml-2 whitespace-nowrap text-xs">Banho</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-tosa-higienica" value="Tosa Higiênica" class="h-4 w-4 rounded"><label for="service-tosa-higienica" class="ml-2 whitespace-nowrap text-xs">Tosa Higiênica</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-tosa-geral" value="Tosa" class="h-4 w-4 rounded"><label for="service-tosa-geral" class="ml-2 whitespace-nowrap text-xs">Tosa</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-hidratacao" value="Hidratação" class="h-4 w-4 rounded"><label for="service-hidratacao" class="ml-2 whitespace-nowrap text-xs">Hidratação</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-escovacao" value="Escov. Dente" class="h-4 w-4 rounded"><label for="service-escovacao" class="ml-2 whitespace-nowrap text-xs">Escov. Dente</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-combo" value="Combo" class="h-4 w-4 rounded"><label for="service-combo" class="ml-2 whitespace-nowrap text-xs">Combo</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-remocao" value="Remoção" class="h-4 w-4 rounded"><label for="service-remocao" class="ml-2 whitespace-nowrap text-xs">Remoção</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-pacote" value="Pacote de Banho" class="h-4 w-4 rounded"><label for="service-pacote" class="ml-2 whitespace-nowrap text-xs">Pacote de Banho</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-taxi" value="Taxi Dog" class="h-4 w-4 rounded"><label for="service-taxi" class="ml-2 whitespace-nowrap text-xs">Taxi Dog</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-creche" value="Creche/Hotel" class="h-4 w-4 rounded"><label for="service-creche" class="ml-2 whitespace-nowrap text-xs">Creche/Hotel</label></div>
                                <div class="flex items-center"><input type="checkbox" id="service-sala-vip" value="Sala VIP" class="h-4 w-4 rounded"><label for="service-sala-vip" class="ml-2 whitespace-nowrap text-xs">Sala VIP</label></div>
                            </div>
                        </div>
                        <!-- Conditional Sub-Services for Remoção -->
                        <div id="remocao-sub-services" class="hidden pl-4 border-l-2 border-teal-300 ml-2 mt-2">
                            <p class="text-sm font-semibold mb-1">Detalhes da Remoção:</p>
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1">
                                <div class="flex items-center"><input type="checkbox" id="sub-service-no" value="Nó" class="h-4 w-4 rounded"><label for="sub-service-no" class="ml-2 text-sm whitespace-nowrap">Nó</label></div>
                                <div class="flex items-center"><input type="checkbox" id="sub-service-pelos" value="Pelos mortos" class="h-4 w-4 rounded"><label for="sub-service-pelos" class="ml-2 text-sm whitespace-nowrap">Pelos mortos</label></div>
                                <div class="flex items-center"><input type="checkbox" id="sub-service-subpelos" value="Subpelos" class="h-4 w-4 rounded"><label for="sub-service-subpelos" class="ml-2 text-sm whitespace-nowrap">Subpelos</label></div>
                            </div>
                        </div>
                    </div>


                    <!-- Conditional Calendar for Bath Package -->
                    <div id="bath-package-calendar-container" class="hidden p-3 bg-violet-800 rounded-lg">
                        <p class="text-sm font-semibold mb-1">Datas do Pacote:</p>
                        <div id="calendar-for-package" class="calendar-container"></div>
                        <div id="selected-dates-summary-package" class="mt-2 text-xs"></div>
                    </div>
                    
                    <!-- Conditional Taxi Dog Details -->
                    <div id="taxi-dog-details-container" class="hidden space-y-3 pt-2 pl-4 border-l-2 border-teal-300 ml-2">
                        <p class="text-sm font-semibold mb-1">Detalhes do Taxi Dog:</p>
                        <div>
                            <label for="pickup-time" class="block text-xs font-medium">Horário de Busca</label>
                            <input type="time" id="pickup-time" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900 text-sm">
                        </div>
                        <div>
                            <label for="return-time" class="block text-xs font-medium">Horário de Devolução</label>
                            <input type="time" id="return-time" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900 text-sm">
                        </div>
                        <div>
                            <label for="client-route" class="block text-xs font-medium">Rota do Cliente</label>
                            <select id="client-route" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900 text-sm">
                                <option value="">Selecione uma rota</option>
                                <option value="Rafael">Rafael</option>
                                <option value="Douglas">Douglas</option>
                                <option value="Matheus">Matheus</option>
                                <option value="Avulso">Avulso</option>
                            </select>
                        </div>
                    </div>

                    <!-- General Observations -->
                    <div>
                        <label for="observations" class="block text-sm font-medium">Observações Gerais</label>
                        <textarea id="observations" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900"></textarea>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" id="submit-appointment-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform transition-transform duration-200 hover:scale-105">Agendar</button>
                    <input type="hidden" id="editing-appointment-id">
                </form>
            </aside>
            
            <!-- Right Side: Main Content Display Area -->
            <div id="main-content-area" class="flex-1 bg-white p-4 md:p-6 rounded-lg shadow-lg border-2 border-[var(--color-primary-base)]">

                <!-- Reception Tab Content -->
                <div id="reception-tab-content" class="tab-content-panel space-y-8">
                    <!-- Daily Appointments Section -->
                    <section>
                        <!-- MODIFICADO: Adicionado wrapper para a barra de controlo fixa -->
                        <div class="sticky-header">
                            <div class="flex flex-wrap justify-between items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <button id="toggle-sidebar-btn" class="p-2 rounded-md bg-gray-200 hover:bg-gray-300 no-print" title="Ocultar/Mostrar formulário">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" />
                                        </svg>
                                    </button>
                                    <h3 class="text-2xl font-bold text-gray-700 flex items-center gap-2"><i class="ph-bold ph-calendar"></i>Agendamentos do Dia</h3>
                                </div>
                                <div class="flex items-center flex-wrap gap-4">
                                    <input type="text" id="reception-search-filter" placeholder="Buscar por Tutor ou Pet..." class="px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm">
                                    <div class="flex items-center gap-2">
                                        <label for="reception-service-filter" class="text-sm font-medium">Serviço:</label>
                                        <select id="reception-service-filter" class="px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm">
                                            <option value="">Todos</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <button class="view-toggle-btn p-1.5 rounded-md" data-tab="reception" data-view="compact"><i class="ph-bold ph-rows text-lg pointer-events-none"></i></button>
                                        <button class="view-toggle-btn p-1.5 rounded-md" data-tab="reception" data-view="grid"><i class="ph-bold ph-squares-four text-lg pointer-events-none"></i></button>
                                        <button class="view-toggle-btn p-1.5 rounded-md" data-tab="reception" data-view="list"><i class="ph-bold ph-list text-lg pointer-events-none"></i></button>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <label for="reception-date-filter" class="text-sm font-medium">Data:</label>
                                        <button id="reception-date-filter" class="date-filter-btn px-3 py-1.5 border border-gray-300 rounded-md shadow-sm bg-white"></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="reception-appointments-list" class="pt-4">
                            <!-- Appointment cards will be inserted here -->
                        </div>
                    </section>
                    
                    <!-- Separator -->
                    <hr class="my-8 border-t-2 border-gray-200">

                    <!-- History Section -->
                    <section>
                         <!-- MODIFICADO: Adicionado wrapper para a barra de controlo fixa -->
                        <div class="sticky-header">
                            <div class="flex flex-wrap justify-between items-center gap-4">
                                <h3 class="text-2xl font-bold text-gray-700 flex items-center gap-2"><i class="ph-bold ph-archive"></i>Histórico de Serviços</h3>
                                <div class="flex flex-wrap items-center gap-2">
                                    <input type="text" id="history-search-filter" placeholder="Buscar por Tutor ou Pet..." class="px-3 py-1.5 border border-gray-300 rounded-md shadow-sm">
                                    <button id="history-date-filter" class="date-filter-btn px-3 py-1.5 border border-gray-300 rounded-md shadow-sm bg-white"></button>
                                    <button id="clear-history-filters-btn" class="px-4 py-1.5 bg-gray-500 text-white rounded-md hover:bg-gray-600">Limpar</button>
                                </div>
                            </div>
                        </div>
                        <div id="history-appointments-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 pt-4">
                             <!-- History cards will be inserted here -->
                        </div>
                         <div id="container-politicas-recepcao" class="mt-6"></div>
                    </section>
                </div>
                
                <!-- Grooming Tab Content -->
                <div id="grooming-tab-content" class="tab-content-panel hidden space-y-6">
                    <!-- MODIFICADO: Adicionado wrapper para a barra de controlo fixa -->
                    <div class="sticky-header">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h3 class="text-2xl font-bold text-gray-700 flex items-center gap-2"><i class="ph-bold ph-scissors"></i>Agenda Banho e Tosa</h3>
                            <div id="digital-clock" class="text-5xl font-bold text-gray-700"></div>
                            <div class="flex items-center gap-4">
                                <div class="flex items-center gap-2">
                                    <label for="grooming-service-filter" class="text-sm font-medium">Filtrar por serviço:</label>
                                    <select id="grooming-service-filter" class="px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-sm">
                                        <option value="">Todos os Serviços</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="grooming-route-filter" class="text-sm font-medium">Filtrar por Rota:</label>
                                    <select id="grooming-route-filter" class="mt-1 block w-full px-2 py-1 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900 text-sm">
                                        <option value="">Todas as Rotas</option>
                                        <option value="Rafael">Rafael</option>
                                        <option value="Douglas">Douglas</option>
                                        <option value="Matheus">Matheus</option>
                                        <option value="Avulso">Avulso</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-1">
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="grooming" data-view="compact"><i class="ph-bold ph-rows text-lg pointer-events-none"></i></button>
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="grooming" data-view="grid"><i class="ph-bold ph-squares-four text-lg pointer-events-none"></i></button>
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="grooming" data-view="list"><i class="ph-bold ph-list text-lg pointer-events-none"></i></button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="grooming-date-filter" class="text-sm font-medium">Filtrar por data:</label>
                                    <button id="grooming-date-filter" class="date-filter-btn px-3 py-1.5 border border-gray-300 rounded-md shadow-sm bg-white"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                     <!-- Remessa & Summary Section -->
                    <div class="flex justify-between items-center mb-4 pt-4">
                        <div id="remessa-controls-wrapper" class="flex flex-wrap gap-2">
                            <button id="start-remessa-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Criar Remessa</button>
                            <button id="remocao-control-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Controle de Remoção</button>
                            <div id="active-remessa-controls" class="hidden flex items-center gap-2">
                                <input type="text" id="remessa-name-input" placeholder="Nome da Remessa" class="px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-gray-800">
                                <button id="finalize-remessa-btn" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600">Finalizar</button>
                                <button id="cancel-remessa-btn" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600">Cancelar</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-blue-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-blue-800">Pets na Fila</p>
                                <p id="pets-in-queue-count" class="text-3xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="bg-green-100 p-4 rounded-lg text-center">
                                <p class="text-sm font-medium text-green-800">Pets Finalizados</p>
                                <p id="pets-finalized-count" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                        </div>
                    </div>
                    <div id="grooming-appointments-list">
                        <!-- Grooming appointment cards will be inserted here -->
                    </div>
                    
                    <hr class="my-8 border-t-2 border-gray-200">
                    <section id="creche-section">
                        <h3 class="text-2xl font-bold text-gray-700 flex items-center gap-2 mb-4"><i class="ph-bold ph-moon-stars"></i>Creche / Hotel</h3>
                        <div id="creche-appointments-list">
                            <!-- Creche/Hotel appointments will be inserted here -->
                        </div>
                    </section>

                     <div id="container-politicas-banhoetosa" class="mt-6"></div>
                </div>

                <!-- Taxi Dog Tab Content -->
                <div id="taxi-dog-monitoring-tab-content" class="tab-content-panel hidden space-y-6">
                     <!-- MODIFICADO: Adicionado wrapper para a barra de controlo fixa -->
                    <div class="sticky-header">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h3 class="text-2xl font-bold text-gray-700 flex items-center gap-2"><i class="ph-bold ph-car"></i>Monitoramento Taxi Dog</h3>
                             <div class="flex items-center gap-4">
                                <div class="flex items-center gap-1">
                                     <button class="view-toggle-btn p-1.5 rounded-md" data-tab="taxi-dog" data-view="compact"><i class="ph-bold ph-rows text-lg pointer-events-none"></i></button>
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="taxi-dog" data-view="grid"><i class="ph-bold ph-squares-four text-lg pointer-events-none"></i></button>
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="taxi-dog" data-view="list"><i class="ph-bold ph-list text-lg pointer-events-none"></i></button>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <label for="taxidog-route-filter" class="text-sm font-medium">Filtrar por rota:</label>
                                    <select id="taxidog-route-filter" class="px-3 py-1.5 border border-gray-300 rounded-md shadow-sm">
                                        <option value="">Todas as Rotas</option>
                                        <option value="Rafael">Rafael</option>
                                        <option value="Douglas">Douglas</option>
                                        <option value="Matheus">Matheus</option>
                                        <option value="Avulso">Avulso</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="taxidog-date-filter" class="text-sm font-medium">Filtrar por data:</label>
                                    <button id="taxidog-date-filter" class="date-filter-btn px-3 py-1.5 border border-gray-300 rounded-md shadow-sm bg-white"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="taxi-dog-appointments-list" class="pt-4">
                         <!-- Taxi Dog appointment cards will be inserted here -->
                    </div>
                    <div id="container-politicas-taxidog" class="mt-6"></div>
                </div>

                <!-- Sala VIP Tab Content -->
                <div id="sala-vip-tab-content" class="tab-content-panel hidden space-y-6">
                     <!-- MODIFICADO: Adicionado wrapper para a barra de controlo fixa -->
                    <div class="sticky-header">
                        <div class="flex flex-wrap justify-between items-center gap-4">
                            <h3 class="text-2xl font-bold text-gray-700 flex items-center gap-2"><i class="ph-bold ph-crown"></i>Monitoramento Sala VIP</h3>
                             <div class="flex items-center gap-4">
                                <div class="flex items-center gap-1">
                                     <button class="view-toggle-btn p-1.5 rounded-md" data-tab="sala-vip" data-view="compact"><i class="ph-bold ph-rows text-lg pointer-events-none"></i></button>
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="sala-vip" data-view="grid"><i class="ph-bold ph-squares-four text-lg pointer-events-none"></i></button>
                                    <button class="view-toggle-btn p-1.5 rounded-md" data-tab="sala-vip" data-view="list"><i class="ph-bold ph-list text-lg pointer-events-none"></i></button>
                                </div>
                                <div class="flex items-center gap-2">
                                    <label for="salavip-date-filter" class="text-sm font-medium">Filtrar por data:</label>
                                    <button id="salavip-date-filter" class="date-filter-btn px-3 py-1.5 border border-gray-300 rounded-md shadow-sm bg-white"></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="sala-vip-appointments-list" class="pt-4">
                         <!-- Sala VIP appointment cards will be inserted here -->
                    </div>
                    <div id="container-politicas-salavip" class="mt-6"></div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- ADICIONADO: Modal do Calendário -->
    <div id="calendar-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-4 w-11/12 md:w-auto">
            <div id="calendar-modal-content" class="text-gray-800">
                <!-- O calendário será renderizado aqui pelo JavaScript -->
            </div>
        </div>
    </div>

    <!-- Generic Feedback Modal -->
    <div id="feedback-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center">
            <p id="feedback-message" class="text-lg"></p>
            <button onclick="document.getElementById('feedback-modal').classList.add('hidden')" class="mt-4 px-4 py-2 bg-teal-500 text-white rounded-md">Fechar</button>
        </div>
    </div>
    
    <!-- Edit Appointment Modal (re-uses form structure) -->
    <div id="edit-appointment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-11/12 md:w-2/3 lg:w-1/2 max-h-[90vh] overflow-y-auto">
             <!-- The form from the main page will be cloned and modified here by JS -->
             <div id="edit-modal-content"></div>
        </div>
    </div>
    
    <!-- Service Request Modal -->
    <div id="service-request-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4">Solicitar Serviço Adicional</h3>
            <form id="service-request-form" class="space-y-4">
                <div id="service-request-container" class="text-gray-800"></div>
                <div>
                    <label for="service-request-observations" class="block text-sm font-medium text-gray-700">Observações Adicionais</label>
                    <textarea id="service-request-observations" rows="3" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-gray-900"></textarea>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button id="send-service-request-btn" type="submit" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600">Enviar Solicitação</button>
                    <button type="button" id="cancel-service-request-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md">Cancelar</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Package Dates Only Modal -->
    <div id="edit-package-dates-only-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-auto">
             <h3 class="text-xl font-bold mb-4 text-center">Editar Datas do Pacote</h3>
             <input type="hidden" id="edit-dates-appointment-id">
             <div id="calendar-for-editing" class="calendar-container"></div>
             <div id="selected-dates-summary-editing" class="mt-4 text-sm text-gray-600"></div>
             <div class="mt-6 flex justify-end gap-3">
                 <button id="save-package-dates-btn" class="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600">Salvar Datas</button>
                 <button type="button" onclick="document.getElementById('edit-package-dates-only-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center">
            <h3 id="confirmation-title" class="text-xl font-bold mb-4">Confirmar Exclusão</h3>
            <p id="confirmation-message" class="mb-6">Tem certeza que deseja excluir este agendamento? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center gap-4">
                <button id="confirm-delete-btn" class="px-6 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirmar</button>
                <button id="cancel-delete-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Removal Control Modal -->
    <div id="remocao-control-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Controle de Remoção</h3>
                <button id="close-remocao-modal-btn" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div class="space-y-6">
                <!-- Registration Form -->
                <form id="remocao-form" class="p-4 border rounded-lg space-y-4">
                    <h4 class="font-semibold text-lg">Registar Novo Serviço</h4>
                    <div>
                        <label for="remocao-date" class="block text-sm font-medium">Data</label>
                        <button id="remocao-date" type="button" class="date-filter-btn mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left"></button>
                    </div>
                    <div>
                        <label for="remocao-handler-name" class="block text-sm font-medium">Executor</label>
                        <input type="text" id="remocao-handler-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-gray-900" required>
                    </div>
                     <div>
                        <label for="remocao-pet-name" class="block text-sm font-medium">Nome do Pet</label>
                        <input type="text" id="remocao-pet-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-gray-900" required>
                    </div>
                    <button type="submit" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                </form>

                <!-- History Section -->
                <div class="p-4 border rounded-lg">
                    <h4 class="font-semibold text-lg mb-4">Histórico de Remoções</h4>
                    <div class="flex gap-4 mb-4">
                        <button id="remocao-day-filter" class="date-filter-btn flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white text-left"></button>
                        <input type="month" id="remocao-month-filter" class="flex-1 px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div id="remocao-list" class="space-y-2 max-h-64 overflow-y-auto">
                        <!-- History items will be injected here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="print-area" class="hidden"></div>
    
    <!-- Virtual Keyboard -->
    <div id="virtual-keyboard-container" class="fixed bottom-0 left-0 w-full bg-gray-200 p-2 rounded-t-lg shadow-lg z-60 transform translate-y-full no-print">
        <div id="virtual-keyboard" class="space-y-1"></div>
    </div>
    
    <!-- Password Modal -->
    <div id="password-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/4">
            <h3 class="text-xl font-bold mb-4 text-center">Acesso Restrito</h3>
            <p class="text-center text-sm mb-4 text-gray-600">Por favor, insira a senha para trocar de aba.</p>
            <input type="password" id="password-input" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            <p id="password-error" class="text-red-500 text-xs text-center mt-2 hidden">Senha incorreta!</p>
            <div class="mt-6 flex justify-end gap-3">
                <button id="confirm-password-btn" class="px-4 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600">Confirmar</button>
                <button id="cancel-password-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Finalize Appointment Modal -->
    <div id="finalize-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-1/3 text-center">
            <h3 class="text-xl font-bold mb-4">Identificar Executor</h3>
            <p class="mb-4">Por favor, digite quem finalizou o serviço.</p>
            <input type="text" id="finalize-handler-input" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-gray-900" placeholder="Nome do executor...">
            <div class="mt-6 flex justify-center gap-4">
                 <button id="confirm-finalize-btn" class="px-6 py-2 bg-teal-500 text-white rounded-md hover:bg-teal-600">Confirmar</button>
                 <button id="cancel-finalize-btn" class="px-6 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- P.O.P Modal -->
    <div id="pop-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 md:w-2/3 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                 <h3 id="info-modal-title" class="text-2xl font-bold text-gray-800">Procedimento Operacional Padrão</h3>
                 <button id="close-pop-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div id="info-modal-content" class="prose max-w-none">
                <!-- Content will be inserted by JS -->
            </div>
        </div>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, addDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, Timestamp, serverTimestamp, writeBatch
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL VARIABLES & STATE ---
        let db, auth, userId, appId;
        let allAppointments = [];
        let allRemovals = [];
        let hasRealtimeListenersStarted = false;
        let calendarState = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDates: new Set()
        };
        let editCalendarState = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            selectedDates: new Set()
        };
        // ADICIONADO: Estado para o calendário de filtro
        let filterCalendarState = {
            currentMonth: new Date().getMonth(),
            currentYear: new Date().getFullYear(),
            activeFilterId: null
        };
        const viewModes = {
            reception: 'grid',
            grooming: 'grid',
            'taxi-dog': 'grid',
            'sala-vip': 'grid'
        };
        const gridLayouts = {
            reception: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4',
            compact_reception: 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2 place-content-start',
            history: 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4',
            grooming: 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 place-content-start',
            compact_grooming: 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2 place-content-start',
            'taxi-dog': 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 place-content-start',
            compact_taxidog: 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2 place-content-start',
            'sala-vip': 'grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 place-content-start',
            compact_salavip: 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2 place-content-start'
        };
        let activeTabId = 'reception-tab-content';
        const TAB_SWITCH_PASSWORD = "256"; 
        let isRemessaModeActive = false;
        let selectedForRemessa = [];
        let currentRemessaId = null; 
        
        // --- FUNCTION DEFINITIONS (Organized for clarity and to prevent ReferenceError) ---

        function showFeedback(message, type = 'success') {
            const modal = document.getElementById('feedback-modal'), p = document.getElementById('feedback-message');
            p.textContent = message; p.className = type==='success'?'text-green-700':'text-red-700';
            modal.classList.remove('hidden'); setTimeout(() => modal.classList.add('hidden'), 3000);
        }

        // ADICIONADO: Função para contagem avançada de pets
        function getPetCount(appointment) {
            const petName = appointment.petName?.trim() || '';
            if (!petName) {
                return 0;
            }

            // Verifica se o nome é puramente numérico
            if (/^\d+$/.test(petName)) {
                const count = parseInt(petName, 10);
                return isNaN(count) ? 1 : count;
            }
            
            // Verifica se há múltiplos nomes separados por "/"
            if (petName.includes('/')) {
                return petName.split('/').filter(name => name.trim() !== '').length;
            }

            // Padrão para 1 pet
            return 1;
        }
        
        // --- REMESSA FUNCTIONS ---
        function startRemessaMode() {
            isRemessaModeActive = true;
            selectedForRemessa = [];
            currentRemessaId = null;
            document.getElementById('grooming-tab-content').classList.add('remessa-selection-active');
            document.getElementById('start-remessa-btn').classList.add('hidden');
            document.getElementById('active-remessa-controls').classList.remove('hidden');
            document.getElementById('remessa-name-input').value = '';
            renderAllContent();
        }
        
        // MODIFICADO: A função agora ordena os pets pela ordem salva ao entrar no modo de edição.
        function startEditRemessaMode(remessaId, remessaName) {
            isRemessaModeActive = true;
            currentRemessaId = remessaId;
            selectedForRemessa = allAppointments
                .filter(app => app.remessaId === remessaId)
                .sort((a, b) => (a.remessaOrder ?? 0) - (b.remessaOrder ?? 0)) // Ordena pela ordem da remessa
                .map(app => app.id);
            
            document.getElementById('grooming-tab-content').classList.add('remessa-selection-active');
            document.getElementById('start-remessa-btn').classList.add('hidden');
            document.getElementById('active-remessa-controls').classList.remove('hidden');
            document.getElementById('remessa-name-input').value = remessaName;
            renderAllContent();
        }

        function exitRemessaMode() {
            isRemessaModeActive = false;
            document.getElementById('grooming-tab-content').classList.remove('remessa-selection-active');
            document.getElementById('start-remessa-btn').classList.remove('hidden');
            document.getElementById('active-remessa-controls').classList.add('hidden');
            document.getElementById('remessa-name-input').value = '';
            selectedForRemessa = [];
            currentRemessaId = null;
            renderAllContent();
        }

        function toggleRemessaSelection(id) {
            const index = selectedForRemessa.indexOf(id);
            if (index > -1) {
                selectedForRemessa.splice(index, 1);
            } else {
                selectedForRemessa.push(id);
            }
            renderAllContent();
        }

        // MODIFICADO: A função agora salva a ordem sequencial dos pets na remessa.
        async function finalizeRemessa() {
            const name = document.getElementById('remessa-name-input').value;
            if (!name.trim()) {
                showFeedback("Por favor, insira um nome para a remessa.", 'error');
                return;
            }
            if (selectedForRemessa.length === 0) {
                showFeedback("Nenhum pet selecionado para a remessa.", 'error');
                exitRemessaMode();
                return;
            }
            
            const remessaId = currentRemessaId || `remessa_${Date.now()}`;
            const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
            const batch = writeBatch(db);

            const updatedAppIds = new Set(selectedForRemessa);

            // Prepara as atualizações para o Firestore, incluindo a ordem da remessa
            selectedForRemessa.forEach((appointmentId, index) => {
                const docRef = doc(db, `artifacts/${appId}/public/data/appointments`, appointmentId);
                const data = { 
                    remessaName: name, 
                    remessaId, 
                    remessaColor: randomColor,
                    remessaOrder: index // Salva a ordem (0, 1, 2...)
                };
                if (!currentRemessaId) {
                    data.remessaCreatedAt = serverTimestamp();
                }
                batch.update(docRef, data);
            });

            // Se estiver editando, remove os dados da remessa dos pets que foram desmarcados
            if (currentRemessaId) {
                const appsToRemove = allAppointments.filter(app => app.remessaId === currentRemessaId && !updatedAppIds.has(app.id));
                appsToRemove.forEach(app => {
                    const docRef = doc(db, `artifacts/${appId}/public/data/appointments`, app.id);
                    batch.update(docRef, { remessaName: null, remessaId: null, remessaCreatedAt: null, remessaColor: null, remessaOrder: null });
                });
            }

            try {
                await batch.commit();
                
                // --- Aplica a atualização otimista ao estado local ---
                let appsToReset = new Set();
                if (currentRemessaId) {
                     allAppointments.forEach(app => {
                        if(app.remessaId === currentRemessaId && !selectedForRemessa.includes(app.id)) {
                            appsToReset.add(app.id);
                        }
                     });
                }

                allAppointments = allAppointments.map(app => {
                    const selectionIndex = selectedForRemessa.indexOf(app.id);
                    if (selectionIndex !== -1) { // Se o app está na seleção atual
                        return { 
                            ...app, 
                            remessaName: name, 
                            remessaId, 
                            remessaColor: randomColor, 
                            remessaOrder: selectionIndex // Adiciona a ordem
                        };
                    }
                    if (appsToReset.has(app.id)) { // Se o app foi removido de uma remessa existente
                        const newApp = { ...app };
                        delete newApp.remessaName;
                        delete newApp.remessaId;
                        delete newApp.remessaCreatedAt;
                        delete newApp.remessaColor;
                        delete newApp.remessaOrder; // Remove a ordem
                        return newApp;
                    }
                    return app;
                });

                showFeedback(`Remessa "${name}" salva com sucesso!`);
            } catch (error) {
                showFeedback("Erro ao salvar a remessa.", "error");
                console.error("Error creating remessa: ", error);
            } finally {
                exitRemessaMode();
            }
        }

        // --- REMOÇÃO FUNCTIONS ---
        function openRemocaoModal() {
            document.getElementById('remocao-control-modal').classList.remove('hidden');
            renderRemocaoHistory();
        }
        
        async function handleRemocaoFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const dateButton = form.querySelector('#remocao-date');
            const date = dateButton ? dateButton.dataset.date : '';
            const handlerName = form.querySelector('#remocao-handler-name').value;
            const petName = form.querySelector('#remocao-pet-name').value;

            if (!date || !handlerName || !petName) {
                showFeedback('Por favor, preencha todos os campos.', 'error');
                return;
            }

            const removalData = {
                date,
                handlerName,
                petName,
                createdAt: serverTimestamp()
            };

            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/removals`), removalData);
                showFeedback('Registo de remoção salvo com sucesso!');
                form.reset();
                initDateFilters();
            } catch (error) {
                showFeedback(`Erro ao salvar: ${error.message}`, 'error');
                console.error("Error saving removal record: ", error);
            }
        }
        
        function renderRemocaoHistory() {
             const listEl = document.getElementById('remocao-list');
             const dayFilterBtn = document.getElementById('remocao-day-filter');
             const dayFilter = dayFilterBtn ? dayFilterBtn.dataset.date : '';
             const monthFilter = document.getElementById('remocao-month-filter').value;

            let filteredRemovals = allRemovals;

            if (dayFilter) {
                filteredRemovals = filteredRemovals.filter(r => r.date === dayFilter);
            } else if (monthFilter) {
                filteredRemovals = filteredRemovals.filter(r => r.date && r.date.startsWith(monthFilter));
            }

            filteredRemovals.sort((a,b) => {
                const dateA = a.createdAt?.toDate ? a.createdAt.toDate() : new Date(0);
                const dateB = b.createdAt?.toDate ? b.createdAt.toDate() : new Date(0);
                return dateB - dateA;
            });

            if(filteredRemovals.length === 0) {
                listEl.innerHTML = `<p class="text-gray-500 text-center">Nenhum registo encontrado.</p>`;
                return;
            }

            listEl.innerHTML = filteredRemovals.map(removal => `
                <div class="flex justify-between items-center bg-gray-100 p-2 rounded">
                    <div>
                        <p class="font-semibold">${removal.petName} - <span class="font-normal">${new Date(removal.date + 'T00:00:00').toLocaleDateString('pt-BR')}</span></p>
                        <p class="text-sm text-gray-600">Executor: ${removal.handlerName}</p>
                    </div>
                    <button data-id="${removal.id}" data-type="remocao" class="delete-remocao-btn text-red-500 hover:text-red-700 font-bold px-2">&times;</button>
                </div>
            `).join('');
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppAndAuth();
            setupEventListeners();
            initDateFilters();
            switchTab('reception-tab-content', true);
            setInterval(updateClock, 1000); // Inicia o relógio
        });

        // REVERTIDO: Lógica de autenticação para acesso anônimo
        function initializeAppAndAuth() {
            try {
                const firebaseConfig = {
                  apiKey: "AIzaSyAe12mlm0UHfi8S31XMrKCgfVhXhjJ_BQY",
                  authDomain: "banho-e6a59.firebaseapp.com",
                  projectId: "banho-e6a59",
                  storageBucket: "banho-e6a59.firebasestorage.app",
                  messagingSenderId: "588155731269",
                  appId: "1:588155731269:web:158811c35e4c20b2ddd22c",
                  measurementId: "G-29KE4608TF"
                };

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                appId = firebaseConfig.appId;
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `ID de Sessão: ${userId}`;
                        if (!hasRealtimeListenersStarted) {
                            setupRealtimeListeners();
                        }
                    } else {
                        // Se não houver utilizador, faz login anónimo
                        try {
                           await signInAnonymously(auth);
                        } catch (error) {
                           console.error("Anonymous Authentication Error:", error);
                           // CORRIGIDO: Deteta erro específico de configuração e informa o utilizador
                           if (error.code === 'auth/admin-restricted-operation') {
                                showFeedback('Erro de Configuração: Ative o login anónimo na consola do Firebase.', 'error');
                           } else {
                                showFeedback(`Erro de autenticação: ${error.message}`, 'error');
                           }
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                showFeedback(`Erro ao iniciar o sistema: ${error.message}`, 'error');
            }
        }

        function setupEventListeners() {
            // REMOVIDO: Event listener do botão de logout
            
            document.querySelectorAll('.tab-button').forEach(b => b.addEventListener('click', () => handleTabClick(b.dataset.tab)));
            document.getElementById('appointment-form').addEventListener('submit', handleFormSubmit);

            document.body.addEventListener('change', (e) => {
                const form = e.target.closest('form');
                if (!form) return;
                const getElem = (id) => form.querySelector(`[id^="${id}"]`);

                if (e.target.matches('[id^="service-remocao"]')) getElem('remocao-sub-services')?.classList.toggle('hidden', !e.target.checked);
                if (e.target.matches('[id^="service-pacote"]')) {
                    const calendarWrapper = getElem('bath-package-calendar-container');
                    if (calendarWrapper) {
                        calendarWrapper.classList.toggle('hidden', !e.target.checked);
                        if (e.target.checked) renderCalendar('calendar-for-package', calendarState, form);
                    }
                    const banhoCheckbox = getElem('service-banho');
                    if(banhoCheckbox) { banhoCheckbox.checked = e.target.checked; banhoCheckbox.disabled = e.target.checked; }
                }
                if (e.target.matches('[id^="service-taxi"]')) {
                    getElem('taxi-dog-details-container')?.classList.toggle('hidden', !e.target.checked);
                    getElem('client-route')?.toggleAttribute('required', e.target.checked);
                }
            });

            document.querySelectorAll('.view-toggle-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const { tab, view } = button.dataset;
                    viewModes[tab] = view;
                    renderAllContent();
                });
            });
            
            document.getElementById('toggle-sidebar-btn').addEventListener('click', () => {
                const sidebar = document.getElementById('appointment-aside');
                sidebar.classList.toggle('hidden');
                document.getElementById('toggle-sidebar-btn').querySelector('svg').classList.toggle('rotate-180');
            });
            
            // MODIFICADO: Listener para os botões de data
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.addEventListener('click', () => openFilterCalendar(btn.id));
            });

            ['reception-service-filter', 'grooming-service-filter', 'grooming-route-filter', 'salavip-date-filter', 'taxidog-route-filter', 'remocao-month-filter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', renderAllContent);
                }
            });
            
            // MODIFICADO: Adicionado listener para o novo campo de busca da recepção
            ['history-search-filter', 'reception-search-filter'].forEach(id => {
                 const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', renderAllContent);
                }
            });
            document.getElementById('clear-history-filters-btn')?.addEventListener('click', clearHistoryFilters);
            document.getElementById('main-content-area').addEventListener('click', handleCardActions);
            document.getElementById('service-request-form').addEventListener('submit', handleSendServiceRequest);
            document.getElementById('cancel-service-request-btn').addEventListener('click', () => document.getElementById('service-request-modal').classList.add('hidden'));
            document.getElementById('save-package-dates-btn').addEventListener('click', handleSavePackageDatesOnly);
            
            
            // Remessa Listeners
            document.getElementById('start-remessa-btn').addEventListener('click', startRemessaMode);
            document.getElementById('finalize-remessa-btn').addEventListener('click', finalizeRemessa);
            document.getElementById('cancel-remessa-btn').addEventListener('click', exitRemessaMode);
            
            // Password Modal Listeners
            const passwordModal = document.getElementById('password-modal');
            const confirmPasswordBtn = document.getElementById('confirm-password-btn');
            const cancelPasswordBtn = document.getElementById('cancel-password-btn');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');

            cancelPasswordBtn.addEventListener('click', () => passwordModal.classList.add('hidden'));
            
            confirmPasswordBtn.addEventListener('click', () => {
                if (passwordInput.value === TAB_SWITCH_PASSWORD) {
                    const targetTab = confirmPasswordBtn.dataset.targetTab;
                    switchTab(targetTab, true);
                    passwordModal.classList.add('hidden');
                    passwordInput.value = '';
                    passwordError.classList.add('hidden');
                } else {
                    passwordError.classList.remove('hidden');
                }
            });
            // ADICIONADO: Listener da tecla Enter para o modal de senha
            passwordInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    confirmPasswordBtn.click();
                }
            });

            // Confirmation Modal Listeners
            document.getElementById('cancel-delete-btn').addEventListener('click', () => document.getElementById('confirmation-modal').classList.add('hidden'));
            
            // Remoção Modal Listeners
            document.getElementById('remocao-control-btn').addEventListener('click', openRemocaoModal);
            document.getElementById('close-remocao-modal-btn').addEventListener('click', () => document.getElementById('remocao-control-modal').classList.add('hidden'));
            document.getElementById('remocao-form').addEventListener('submit', handleRemocaoFormSubmit);
            
            // Finalize Modal Listeners
            const finalizeModal = document.getElementById('finalize-modal');
            const finalizeInput = document.getElementById('finalize-handler-input');
            document.getElementById('confirm-finalize-btn').addEventListener('click', (e) => {
                const appointmentId = e.target.dataset.appointmentId;
                const remessaId = e.target.dataset.remessaId;
                const handlerName = finalizeInput.value.trim();

                if (handlerName) {
                    if (appointmentId) {
                        handleFinalize(appointmentId, handlerName);
                    } else if (remessaId) {
                        handleBatchFinalize(remessaId, handlerName);
                    }
                    finalizeModal.classList.add('hidden');
                } else {
                    showFeedback("Por favor, insira o nome do executor.", "error");
                    finalizeInput.focus();
                }
            });
            document.getElementById('cancel-finalize-btn').addEventListener('click', () => {
                finalizeModal.classList.add('hidden');
            });
            // ADICIONADO: Listener da tecla Enter para o modal de finalização
            finalizeInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    document.getElementById('confirm-finalize-btn').click();
                }
            });

            setupVirtualKeyboard();
        }
        
        function handleTabClick(targetTabId) {
            if (targetTabId === activeTabId) return;
            const passwordModal = document.getElementById('password-modal');
            document.getElementById('confirm-password-btn').dataset.targetTab = targetTabId;
            passwordModal.classList.remove('hidden');
            document.getElementById('password-input').focus();
        }

        function setupRealtimeListeners() {
             hasRealtimeListenersStarted = true;
            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/appointments`)), (snapshot) => {
                allAppointments = snapshot.docs.map(doc => {
                    const data = doc.data();
                    // CORRIGIDO: Converte todos os timestamps para datas de uma só vez
                    Object.keys(data).forEach(key => {
                        if (data[key] instanceof Timestamp) {
                            data[key] = data[key].toDate();
                        } else if (key === 'bathPackageDates' && Array.isArray(data[key])) {
                            // Converte timestamps dentro do array bathPackageDates
                            data[key] = data[key].map(ts => (ts instanceof Timestamp ? ts.toDate() : ts));
                        }
                    });
                    return { id: doc.id, ...data };
                });
                populateServiceFilters();
                renderAllContent();
            }, (error) => console.error("Error with appointments listener:", error));

            onSnapshot(query(collection(db, `artifacts/${appId}/public/data/removals`)), (snapshot) => {
                 allRemovals = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 renderRemocaoHistory();
            }, (error) => console.error("Error with removals listener:", error));
        }
        
        function switchTab(tabId, bypassPassword = false) {
            if (!bypassPassword && tabId !== activeTabId) {
                handleTabClick(tabId);
                return;
            }
            
            activeTabId = tabId;

            document.querySelectorAll('.tab-content-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelectorAll('.tab-button').forEach(b => {
                b.classList.toggle('gradient-purple-to-dark-purple', b.dataset.tab === tabId);
                if (b.id !== 'sala-vip-tab-btn') {
                    b.classList.toggle('bg-gray-400', b.dataset.tab !== tabId);
                }
            });
            const sidebar = document.getElementById('appointment-aside');
            if (tabId !== 'reception-tab-content' && !sidebar.classList.contains('hidden')) {
                 sidebar.classList.add('hidden');
            }
            document.getElementById('toggle-sidebar-btn').classList.toggle('hidden', tabId !== 'reception-tab-content');
            renderAllContent(); 
        }
        
        function initDateFilters() {
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            document.querySelectorAll('.date-filter-btn').forEach(btn => {
                btn.dataset.date = todayString;
                btn.textContent = today.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            });
        }
        
        function clearHistoryFilters() {
            document.getElementById('history-search-filter').value = '';
            const today = new Date();
            const todayString = today.toISOString().split('T')[0];
            const historyDateBtn = document.getElementById('history-date-filter');
            historyDateBtn.dataset.date = todayString;
            historyDateBtn.textContent = today.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            renderAllContent();
        }

        function renderAllContent() {
            if (!hasRealtimeListenersStarted) return;
            ['reception', 'history', 'grooming', 'taxi-dog', 'sala-vip'].forEach(renderAppointmentsList);
        }
        
        // MODIFICADO: Adicionada lógica de busca para a recepção
        function getVisibleAppointments(type) {
            let filtered = allAppointments;
            
            const dateFilterIds = { reception: 'reception-date-filter', history: 'history-date-filter', grooming: 'grooming-date-filter', 'taxi-dog': 'taxidog-date-filter', 'sala-vip': 'salavip-date-filter' };
            const dateFilterElement = document.getElementById(dateFilterIds[type]);
            const filterDateStr = dateFilterElement ? dateFilterElement.dataset.date : '';

            if (filterDateStr) {
                filtered = filtered.filter(app => {
                    if (!app.appointmentDatetime) return false;
                    const appDate = new Date(app.appointmentDatetime).toISOString().split('T')[0];
                    return appDate === filterDateStr;
                });
            }

            // Specific filtering logic for each tab
            if (type === 'grooming') {
                filtered = filtered.filter(app => !(app.services && app.services.includes('Sala VIP')));
            }
            if (type === 'sala-vip') {
                filtered = filtered.filter(app => app.services && app.services.includes('Sala VIP'));
            }

            if (type === 'reception') {
                 const searchFilter = document.getElementById('reception-search-filter').value.toLowerCase().trim();
                 if (searchFilter) {
                    filtered = filtered.filter(app => 
                        (app.tutorName || '').toLowerCase().includes(searchFilter) || 
                        (app.petName || '').toLowerCase().includes(searchFilter)
                    );
                }
            }

            if (type === 'history') {
                const searchFilter = document.getElementById('history-search-filter').value.toLowerCase().trim();
                if (searchFilter) {
                    filtered = filtered.filter(app => 
                        (app.tutorName || '').toLowerCase().includes(searchFilter) || 
                        (app.petName || '').toLowerCase().includes(searchFilter)
                    );
                }
            }
            
            if (type === 'reception' || type === 'grooming') {
                const serviceFilter = document.getElementById(`${type}-service-filter`)?.value;
                if(serviceFilter) filtered = filtered.filter(app => app.services.includes(serviceFilter));
            }

            if (type === 'grooming' || type === 'taxi-dog') {
                const routeFilterId = type === 'grooming' ? 'grooming-route-filter' : 'taxidog-route-filter';
                const routeFilter = document.getElementById(routeFilterId)?.value;
                if(routeFilter) filtered = filtered.filter(app => app.clientRoute === routeFilter);
            }
            
            if (type === 'taxi-dog') {
                filtered = filtered.filter(app => app.services && app.services.includes('Taxi Dog'));
            }

            return filtered;
        }

        function renderAppointmentsList(type) {
            const listContainerIds = { reception: 'reception-appointments-list', history: 'history-appointments-list', grooming: 'grooming-appointments-list', 'taxi-dog': 'taxi-dog-appointments-list', 'sala-vip': 'sala-vip-appointments-list' };
            const listElement = document.getElementById(listContainerIds[type]);
            if (!listElement) return;

            updateViewToggleButtons(type);
            
            let filteredAppointments = getVisibleAppointments(type);

            // MODIFICADO: Lógica de ordenação da recepção
            if (type === 'reception') {
                const getStatusScore = (app) => {
                    if (app.isDischarged) return 99; // Itens com baixa vão para o final
                    if (app.serviceRequest?.status === 'Pending') return 0;
                    if (app.status === 'Finalizado' && !app.notifiedAt) return 1;
                    if (app.status === 'Finalizado') return 2;
                    if (app.status === 'Chegou') return 3;
                    if (app.status === 'Agendado') return 4;
                    return 5;
                };

                filteredAppointments.sort((a, b) => {
                    const scoreA = getStatusScore(a);
                    const scoreB = getStatusScore(b);
                    if (scoreA !== scoreB) {
                        return scoreA - scoreB;
                    }
                    
                    const timeA = a.checkinTime || a.appointmentDatetime;
                    const timeB = b.checkinTime || b.appointmentDatetime;
                    return new Date(timeA) - new Date(timeB);
                });
            } else if (type === 'grooming') {
                renderGroomingList(filteredAppointments); 
                return; 
            } else {
                filteredAppointments.sort((a, b) => new Date(b.appointmentDatetime) - new Date(a.appointmentDatetime));
            }

            const currentView = viewModes[type] || 'grid';
            let containerClasses = '';
            const compactGridClass = 'grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 lg:grid-cols-7 gap-2 place-content-start';
            const compactViewClassSuffix = `compact_${type.replace('-', '')}`;
            
            switch (currentView) {
                case 'compact': containerClasses = (gridLayouts[compactViewClassSuffix] || compactGridClass); break;
                case 'grid': containerClasses = gridLayouts[type] || gridLayouts['reception']; break;
                default: containerClasses = 'flex flex-col gap-3'; break;
            }
            listElement.className = containerClasses;

            listElement.innerHTML = filteredAppointments.length > 0 
                ? filteredAppointments.map(app => createAppointmentCardHTML(app, type)).join('') 
                : '<p class="text-gray-500 col-span-full text-center">Nenhum agendamento encontrado para os filtros selecionados.</p>';
        }
        
        // MODIFICADO: Função reescrita para melhor organização visual das remessas.
        function renderGroomingList(allGroomingAppointments) {
            const groomingListElement = document.getElementById('grooming-appointments-list');
            const crecheListElement = document.getElementById('creche-appointments-list');
            const type = 'grooming';

            // --- 1. Lógica de Contagem e Numeração (sem alteração) ---
            allGroomingAppointments.forEach(app => delete app.arrivalNumber);
            const arrivedRegularPets = allGroomingAppointments.filter(app => app.status === 'Chegou' && app.checkinTime && !app.services?.includes('Creche/Hotel')).sort((a, b) => new Date(a.checkinTime) - new Date(b.checkinTime));
            const arrivedCrechePets = allGroomingAppointments.filter(app => app.status === 'Chegou' && app.checkinTime && app.services?.includes('Creche/Hotel')).sort((a, b) => new Date(a.checkinTime) - new Date(b.checkinTime));
            let arrivalCounter = 1;
            arrivedRegularPets.forEach(pet => { pet.arrivalNumber = arrivalCounter++; });
            arrivedCrechePets.forEach(pet => { pet.arrivalNumber = arrivalCounter++; });

            const inProgressCount = allGroomingAppointments.filter(a => a.status !== 'Finalizado').reduce((total, app) => total + getPetCount(app), 0);
            const finalizedCount = allGroomingAppointments.filter(a => a.status === 'Finalizado').reduce((total, app) => total + getPetCount(app), 0);
            document.getElementById('pets-in-queue-count').textContent = inProgressCount;
            document.getElementById('pets-finalized-count').textContent = finalizedCount;

            // --- 2. Separação e Agrupamento dos Agendamentos ---
            const crecheAppointments = allGroomingAppointments.filter(app => app.services?.includes('Creche/Hotel'));
            const regularGroomingAppointments = allGroomingAppointments.filter(app => !app.services?.includes('Creche/Hotel'));

            groomingListElement.innerHTML = '';
            groomingListElement.className = 'space-y-8'; // Espaçamento vertical entre seções

            const remessas = {};
            const noRemessa = [];
            regularGroomingAppointments.forEach(app => {
                if (app.remessaId) {
                    if (!remessas[app.remessaId]) {
                        remessas[app.remessaId] = { name: app.remessaName, apps: [], createdAt: app.remessaCreatedAt || app.createdAt, remessaId: app.remessaId, color: app.remessaColor, isFinalized: true };
                    }
                    if (app.status !== 'Finalizado') remessas[app.remessaId].isFinalized = false;
                    remessas[app.remessaId].apps.push(app);
                } else {
                    noRemessa.push(app);
                }
            });

            for (const remessaId in remessas) {
                remessas[remessaId].apps.sort((a, b) => (a.remessaOrder ?? 99) - (b.remessaOrder ?? 99));
            }

            const activeRemessas = Object.values(remessas).filter(r => !r.isFinalized).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            const finalizedRemessas = Object.values(remessas).filter(r => r.isFinalized).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const activeNoRemessa = noRemessa.filter(a => a.status !== 'Finalizado').sort((a, b) => (a.checkinTime ? new Date(a.checkinTime) : new Date(a.appointmentDatetime)) - (b.checkinTime ? new Date(b.checkinTime) : new Date(b.appointmentDatetime)));
            const finalizedNoRemessa = noRemessa.filter(a => a.status === 'Finalizado').sort((a, b) => new Date(b.finalizedAt) - new Date(a.finalizedAt));

            // --- 3. Definição das Classes da Grade ---
            const currentView = viewModes[type] || 'grid';
            let cardsGridClasses = '';
            const compactViewClassSuffix = `compact_${type.replace('-', '')}`;
            switch (currentView) {
                case 'compact': cardsGridClasses = gridLayouts[compactViewClassSuffix]; break;
                case 'grid': cardsGridClasses = gridLayouts[type]; break;
                default: cardsGridClasses = 'flex flex-col gap-3'; break;
            }

            const hasActiveItems = activeRemessas.length > 0 || activeNoRemessa.length > 0;
            const hasFinalizedItems = finalizedRemessas.length > 0 || finalizedNoRemessa.length > 0;

            if (!hasActiveItems && !hasFinalizedItems) {
                groomingListElement.innerHTML = '<p class="text-gray-500 col-span-full text-center">Nenhum agendamento de banho e tosa encontrado.</p>';
            }

            // --- 4. Renderização das Seções ---
            const createSection = (title, items, isRemessa, isFinalized = false) => {
                const section = document.createElement('div');
                if (isRemessa) {
                    items.forEach((remessa, index) => {
                        const remessaContainer = document.createElement('div');
                        const borderColor = remessa.color || '#8B5CF6';
                        // REVERTIDO: Removido 'w-max' para o container da remessa voltar a ser full-width.
                        remessaContainer.className = 'p-4 border-2 rounded-lg space-y-4 bg-white mb-4';
                        remessaContainer.style.borderColor = borderColor;

                        const header = document.createElement('div');
                        header.className = 'flex justify-between items-start';
                        header.innerHTML = `
                            <div class="flex items-center gap-2">
                                <h3 class="text-xl font-bold" style="color: ${borderColor}">Remessa: ${remessa.name}</h3>
                            </div>
                            <div class="flex flex-col gap-1">
                                ${!isFinalized ? `<button class="finalize-remessa-btn px-3 py-1 text-xs bg-green-500 text-white rounded hover:bg-green-600" data-remessa-id="${remessa.remessaId}">Finalizar Lote</button>` : ''}
                                <button class="edit-remessa-btn px-3 py-1 text-xs bg-yellow-400 text-gray-800 rounded hover:bg-yellow-500" data-remessa-id="${remessa.remessaId}" data-remessa-name="${remessa.name}">Editar</button>
                                <button class="undo-remessa-btn px-3 py-1 text-xs bg-red-500 text-white rounded hover:bg-red-600" data-remessa-id="${remessa.remessaId}">Desfazer</button>
                            </div>`;
                        
                        const cardsContainer = document.createElement('div');
                        cardsContainer.className = cardsGridClasses;
                        cardsContainer.innerHTML = remessa.apps.map(app => createAppointmentCardHTML(app, type)).join('');
                        
                        remessaContainer.appendChild(header);
                        remessaContainer.appendChild(cardsContainer);
                        section.appendChild(remessaContainer);
                    });
                } else if (items.length > 0) {
                    section.innerHTML += `<h4 class="text-lg font-bold text-gray-500 mb-2">${title}</h4>`;
                    const cardsContainer = document.createElement('div');
                    cardsContainer.className = cardsGridClasses;
                    cardsContainer.innerHTML = items.map(app => createAppointmentCardHTML(app, type)).join('');
                    section.appendChild(cardsContainer);
                }
                return section;
            };

            if (hasActiveItems) {
                const activeSection = document.createElement('section');
                activeSection.appendChild(createSection(null, activeRemessas, true));
                activeSection.appendChild(createSection('Avulsos na Fila', activeNoRemessa, false));
                groomingListElement.appendChild(activeSection);
            }

            if (hasFinalizedItems) {
                if (hasActiveItems) groomingListElement.innerHTML += `<hr class="my-8 border-t-2 border-gray-200">`;
                
                const finalizedSection = document.createElement('section');
                finalizedSection.className = 'opacity-60';
                finalizedSection.innerHTML = `<h3 class="text-2xl font-bold text-gray-700 mb-4">Finalizados</h3>`;
                finalizedSection.appendChild(createSection(null, finalizedRemessas, true, true));
                finalizedSection.appendChild(createSection('Avulsos Finalizados', finalizedNoRemessa, false, true));
                groomingListElement.appendChild(finalizedSection);
            }

            // --- 5. Renderização da Creche (sem alteração) ---
            if (!crecheListElement) return;
            crecheAppointments.sort((a,b) => {
                const statusOrder = { 'Chegou': 1, 'Agendado': 2, 'Finalizado': 3 };
                const statusA = statusOrder[a.status] || 99;
                const statusB = statusOrder[b.status] || 99;
                if (statusA !== statusB) return statusA - statusB;
                return new Date(a.appointmentDatetime) - new Date(b.appointmentDatetime);
            });
            let crecheContainerClasses = '';
            const crecheCompactSuffix = `compact_${type.replace('-', '')}`;
            switch (currentView) {
                case 'compact': crecheContainerClasses = (gridLayouts[crecheCompactSuffix] || compactGridClass); break;
                case 'grid': crecheContainerClasses = gridLayouts[type] || gridLayouts['grooming']; break;
                default: crecheContainerClasses = 'flex flex-col gap-3'; break;
            }
            crecheListElement.className = crecheContainerClasses;
            crecheListElement.innerHTML = crecheAppointments.length > 0
                ? crecheAppointments.map(app => createAppointmentCardHTML(app, type)).join('')
                : '<p class="text-gray-500 col-span-full text-center">Nenhum pet na creche/hotel hoje.</p>';
        }

        // MODIFICADO: O botão de seleção agora mostra o número da ordem.
        function createAppointmentCardHTML(app, contextTab) {
            const viewMode = viewModes[contextTab];
            const isCompact = viewMode === 'compact';
            const hasTosa = app.services?.includes('Tosa');
            const hasTaxiDog = app.services?.includes('Taxi Dog');

            let cardBgClass = 'bg-white'; // Default color

            // MODIFICADO: Lógica de cores invertida e simplificada
            if (hasTaxiDog) {
                cardBgClass = 'taxidog-dark-bg'; // Regra 1: Se tem Taxi Dog, é cinza.
            } else if (hasTosa) {
                cardBgClass = 'tosa-yellow-bg'; // Regra 2: Se não tem Taxi Dog mas tem Tosa, é amarelo.
            }
            
            // --- Status-based coloring (overrides all service colors) ---
            if (app.status === 'Chegou') {
                cardBgClass = 'arrived-blue-bg';
            }

            if (app.status === 'Finalizado') {
                if (contextTab === 'reception' && !app.notifiedAt) {
                    cardBgClass = 'attention-orange-bg'; // Laranja: Finalizado, precisa avisar
                } else if (contextTab === 'reception' && !hasTaxiDog) {
                    cardBgClass = 'finalized-dark-green-bg'; // Verde escuro: Avisado, sem taxi
                } else {
                    cardBgClass = 'finalized-green-bg'; // Verde claro: Avisado com taxi, ou outras abas
                }
            }
            
            if (app.serviceRequest?.status === 'Pending') {
                cardBgClass = 'requested-red-bg';
            }

            let cardClasses = `relative p-4 rounded-lg border shadow-md flex flex-col justify-between gap-2 card-servico transition-all duration-200 ${cardBgClass}`;

            if (isCompact) {
                cardClasses += ' compact-card flex-col justify-center items-center text-center';
            }

            if (app.isDischarged) {
                cardClasses += ' opacity-50';
            }
            
            // ADICIONADO: Lógica para borda de aprovação/negação
            if (app.serviceRequest?.status === 'Approved') {
                cardClasses += ' approved-border';
            } else if (app.serviceRequest?.status === 'Denied') {
                cardClasses += ' denied-border';
            }

            const statusStyles = { 'Agendado': 'bg-gray-400 text-white', 'Chegou': 'bg-blue-500 text-white', 'Finalizado': 'bg-green-600 text-white' };
            
            let statusBubbleHTML;
            let pulseClass = '';
            if (contextTab === 'reception' && app.status === 'Finalizado' && !app.notifiedAt) {
                pulseClass = 'animate-pulse';
            }

            if (app.serviceRequest?.status === 'Pending') {
                statusBubbleHTML = `<span class="absolute top-2 right-2 text-xs font-bold px-2 py-1 rounded-full bg-red-500 text-white animate-pulse">Solicitado</span>`;
            } else {
                statusBubbleHTML = `<span class="absolute top-2 right-2 text-xs font-bold px-2 py-1 rounded-full ${statusStyles[app.status] || 'bg-gray-400'} ${pulseClass}">${app.status}</span>`;
            }

            let displayServices = app.services || [];
            const hasSpecificRemoval = displayServices.some(s => s.startsWith('Remoção de'));

            if (hasSpecificRemoval) {
                displayServices = displayServices.filter(s => s !== 'Remoção');
            }
            
            const servicesHTML = displayServices.map(s => {
                let serviceName = s;
                let style = "text-violet-700";
                if (s === 'Pacote de Banho') serviceName = 'Pct';
                if (s === 'Sala VIP') style = "text-amber-600";
                return `<strong class="${style}">${serviceName}</strong>`;
            }).join(', ');

            let taxiInfoHTML = '';
            if (app.services?.includes('Taxi Dog') && app.clientRoute) {
                const details = [app.clientRoute, app.pickupTime && `Busca: ${app.pickupTime}`, app.returnTime && `Devolução: ${app.returnTime}`].filter(Boolean);
                taxiInfoHTML = `<p class="text-xs mt-1 text-gray-600"><strong>Taxi Dog:</strong> ${details.join(' | ')}</p>`;
            }
            
            const packageDatesHTML = (app.services?.includes('Pacote de Banho') && app.bathPackageDates?.length > 0)
                ? `<details class="text-xs mt-1 text-gray-600"><summary class="cursor-pointer font-semibold">Datas do Pacote: (${app.bathPackageDates.length})</summary><ul class="pl-4 list-disc list-inside bg-gray-100 p-2 rounded-md mt-1">${app.bathPackageDates.map(d => `<li>${new Date(d).toLocaleDateString('pt-BR')}</li>`).join('')}</ul><div class="text-right mt-1"><button class="edit-package-dates-btn px-1.5 py-0.5 text-xs bg-blue-500 text-white rounded hover:bg-blue-600" data-id="${app.id}">Editar Datas</button></div></details>`
                : (app.isPackage ? `<p class="text-xs mt-1 text-gray-600"><strong>Pacote:</strong> Sim</p>` : '');


            let requestNotificationHTML = '';
            if (app.serviceRequest?.status) {
                if (contextTab === 'reception' && app.serviceRequest.status === 'Pending') {
                    requestNotificationHTML = `<div class="mt-2 p-2 bg-red-100 border-l-4 border-red-500 text-red-700 text-xs rounded">
                        <p class="font-bold">Solicitação Pendente:</p>
                        <p>${app.serviceRequest.requestedAdditions.join(', ')}</p>
                        ${app.serviceRequest.newObservations ? `<p class="mt-1"><strong>Obs:</strong> ${app.serviceRequest.newObservations}</p>` : ''}
                        <div class="flex justify-end gap-2 mt-2">
                            <button class="approve-request-btn px-2 py-1 text-xs bg-green-500 text-white rounded" data-id="${app.id}">Liberar</button>
                            <button class="deny-request-btn px-2 py-1 text-xs bg-red-500 text-white rounded" data-id="${app.id}">Negar</button>
                        </div></div>`;
                } else if (contextTab === 'grooming' || contextTab === 'sala-vip') {
                     if (app.serviceRequest.status === 'Approved') requestNotificationHTML = `<p class="text-xs mt-2 font-bold text-green-600">Solicitação Aprovada</p>`;
                    else if (app.serviceRequest.status === 'Denied') requestNotificationHTML = `<p class="text-xs mt-2 font-bold text-red-600">Solicitação Negada</p>`;
                }
            }
            
            let buttonsHTML = '';
            if (contextTab === 'reception') {
                buttonsHTML += `<button class="edit-btn px-1.5 py-0.5 text-xs bg-yellow-400 text-gray-800 rounded" data-id="${app.id}">Editar</button>`;
                if (app.status === 'Agendado' && !app.isDischarged) buttonsHTML += `<button class="checkin-btn px-1.5 py-0.5 text-xs bg-blue-500 text-white rounded" data-id="${app.id}">Chegou</button>`;
                if (app.status === 'Finalizado' && !app.isDischarged && !app.notifiedAt) buttonsHTML += `<button class="notify-btn px-1.5 py-0.5 text-xs bg-cyan-500 text-white rounded" data-id="${app.id}">Avisado</button>`;
                if (app.status === 'Finalizado' && !app.isDischarged && app.notifiedAt) buttonsHTML += `<button class="discharge-btn px-1.5 py-0.5 text-xs bg-emerald-500 text-white rounded" data-id="${app.id}">Baixa</button>`;
                buttonsHTML += `<button class="delete-btn px-1.5 py-0.5 text-xs bg-red-500 text-white rounded" data-id="${app.id}">Excluir</button>`;
            }
            if (contextTab === 'grooming' || contextTab === 'sala-vip') {
                 if (app.status === 'Finalizado') {
                     buttonsHTML += `<button class="revert-finalize-btn px-1.5 py-0.5 text-xs bg-gray-500 text-white rounded" data-id="${app.id}">Reverter</button>`;
                 } else {
                     buttonsHTML += `<button class="finalize-btn px-1.5 py-0.5 text-xs bg-green-500 text-white rounded" data-id="${app.id}">Finalizar</button>`;
                 }
                 if(!app.serviceRequest || app.serviceRequest.status !== 'Pending') buttonsHTML += `<button class="request-service-btn px-1.5 py-0.5 text-xs bg-orange-500 text-white rounded" data-id="${app.id}">Solicitar Serviço</button>`;
            }
            if (contextTab === 'taxi-dog') {
                if (app.status === 'Agendado') {
                     buttonsHTML += `<button class="checkin-btn px-1.5 py-0.5 text-xs bg-blue-500 text-white rounded" data-id="${app.id}">Chegou</button>`;
                }
            }
            // ADICIONADO: Botão de Replicar no Histórico
            if (contextTab === 'history') {
                buttonsHTML += `<button class="replicate-btn px-1.5 py-0.5 text-xs bg-blue-500 text-white rounded" data-id="${app.id}">Replicar</button>`;
            }
            
            const arrivalNumberHTML = app.arrivalNumber ? `<span class="absolute top-1 left-1 bg-violet-600 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">#${app.arrivalNumber}</span>` : '';
            
            let remessaButtonHTML = '';
            if (isRemessaModeActive && (app.status === 'Chegou' || app.status === 'Agendado') && (!currentRemessaId || app.remessaId === currentRemessaId || !app.remessaId)) {
                const selectionIndex = selectedForRemessa.indexOf(app.id);
                const isSelected = selectionIndex > -1;
                if (isSelected) cardClasses += ' selected-for-remessa';
                remessaButtonHTML = `
                    <button class="remessa-select-btn absolute top-1 left-1 z-10 h-6 w-6 rounded-full border-2 ${isSelected ? 'bg-teal-500 border-teal-700' : 'bg-white border-gray-400'} flex items-center justify-center" data-id="${app.id}">
                        ${isSelected ? `<span class="text-white font-bold text-xs">${selectionIndex + 1}</span>` : ''}
                    </button>`;
            }

            const compactViewHTML = `
                <div class="compact-summary flex flex-col justify-center items-center h-full text-center p-2 pt-8">
                     <h4 class="text-lg font-bold text-gray-800 truncate card-nome-pet">${app.petName}</h4>
                     <p class="text-sm font-medium text-gray-500 card-nome-tutor">(${app.tutorName})</p>
                </div>`;
            
            const fullViewHTML = `
                <div class="full-details ${isCompact ? 'hidden' : ''}">
                     <div>
                        <h4 class="text-lg font-bold text-gray-800 card-nome-pet">${app.petName} <span class="text-sm font-medium text-gray-500 card-nome-tutor">(${app.tutorName})</span></h4>
                        <p class="text-sm text-gray-600"><strong>Raça:</strong> ${app.petBreed}</p>
                        <p class="text-sm text-gray-600 card-horario"><strong>Agendado:</strong> ${app.appointmentDatetime ? new Date(app.appointmentDatetime).toLocaleString('pt-BR') : 'N/A'}</p>
                        ${app.checkinTime ? `<p class="text-sm text-blue-600"><strong>Chegada:</strong> ${new Date(app.checkinTime).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>` : ''}
                        ${app.finalizedAt ? `<p class="text-sm text-green-600"><strong>Finalizado:</strong> ${new Date(app.finalizedAt).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})} ${app.finalizedBy ? `<strong>(${app.finalizedBy})</strong>` : ''}</p>` : ''}
                        ${app.notifiedAt ? `<p class="text-sm text-cyan-600"><strong>Avisado:</strong> ${new Date(app.notifiedAt).toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'})}</p>` : ''}
                        <hr class="my-2">
                        <p class="text-sm text-gray-800 card-servicos"><strong>Serviços:</strong> ${servicesHTML}</p>
                        ${app.observations ? `<p class="text-xs mt-1 text-gray-600 bg-yellow-50 p-1 rounded"><strong>Obs:</strong> ${app.observations}</p>` : ''}
                        ${packageDatesHTML} ${taxiInfoHTML} ${requestNotificationHTML}
                    </div>
                    <div class="flex flex-col sm:flex-row flex-wrap justify-end gap-0.5 mt-2">${buttonsHTML}</div>
                </div>`;
            
            return `<div class="${cardClasses}" data-id="${app.id}" data-remessa-id="${app.remessaId || ''}" data-datetime="${app.appointmentDatetime}">
                ${remessaButtonHTML || arrivalNumberHTML}
                ${statusBubbleHTML}
                ${isCompact ? compactViewHTML + fullViewHTML : fullViewHTML}
            </div>`;
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const form = e.target, id = form.querySelector('#editing-appointment-id').value;
            const button = form.querySelector('button[type="submit"]');
            button.disabled = true; button.textContent = id ? 'A guardar...' : 'A agendar...';
            
            try {
                const data = getAppointmentDataFromForm(form);
                const isPackage = data.services.includes('Pacote de Banho');

                if (id) { 
                    await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { ...data, appointmentDatetime: Timestamp.fromDate(new Date(data.appointmentDatetime)), updatedAt: serverTimestamp() });
                    showFeedback("Agendamento atualizado!");
                    document.getElementById('edit-appointment-modal').classList.add('hidden');
                } else {
                    // CORRIGIDO: Adiciona validação para garantir que a data/hora foi preenchida
                    if (!data.appointmentDatetime) {
                        showFeedback("Por favor, preencha o campo 'Data e Hora'.", "error");
                        return; // Interrompe a execução se o campo estiver vazio
                    }

                    if (isPackage && calendarState.selectedDates.size > 0) {
                        const originalTime = new Date(data.appointmentDatetime).toTimeString().split(' ')[0];
                        const baseData = { ...data, status: 'Agendado', isPackage: true, isDischarged: false, notifiedAt: null }; 
                        delete baseData.bathPackageDates; 
                        delete baseData.appointmentDatetime;

                        for (const dateStr of calendarState.selectedDates) {
                            const newDate = new Date(`${dateStr}T${originalTime}`);
                            const packageAppointmentData = { ...baseData, appointmentDatetime: Timestamp.fromDate(newDate), createdAt: serverTimestamp() };
                            await addDoc(collection(db, `artifacts/${appId}/public/data/appointments`), packageAppointmentData);
                        }
                        showFeedback(`${calendarState.selectedDates.size} agendamentos do pacote foram criados!`);
                    } else {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/appointments`), { ...data, appointmentDatetime: Timestamp.fromDate(new Date(data.appointmentDatetime)), createdAt: serverTimestamp(), status: 'Agendado', isDischarged: false, notifiedAt: null });
                        showFeedback("Agendamento criado!");
                    }
                    resetFormState();
                }
            } catch (error) { 
                showFeedback(`Erro ao processar o agendamento: ${error.message}`, "error");
                console.error("Form submission error:", error);
            } finally { 
                button.disabled = false; 
                button.textContent = id ? 'Guardar Alterações' : 'Agendar'; 
            }
        }

        function getAppointmentDataFromForm(form) {
            const services = Array.from(form.querySelectorAll('[id^="service-"]:checked')).map(cb => cb.value);
            if (services.includes('Remoção')) services.push(...Array.from(form.querySelectorAll('[id^="sub-service-"]:checked')).map(cb => `Remoção de ${cb.value}`));
            return {
                tutorName: form.querySelector('[id^="tutor-name"]').value, petName: form.querySelector('[id^="pet-name"]').value, petBreed: form.querySelector('[id^="pet-breed"]').value,
                appointmentDatetime: form.querySelector('[id^="appointment-datetime"]').value, services: services,
                bathPackageDates: services.includes('Pacote de Banho') ? Array.from(calendarState.selectedDates) : [],
                pickupTime: form.querySelector('[id^="pickup-time"]').value || null, returnTime: form.querySelector('[id^="return-time"]').value || null,
                clientRoute: form.querySelector('[id^="client-route"]').value || null, observations: form.querySelector('[id^="observations"]').value || null,
            };
        }

        function resetFormState() {
            const form = document.getElementById('appointment-form');
            form.reset();

            form.querySelector('#remocao-sub-services').classList.add('hidden');
            form.querySelector('#bath-package-calendar-container').classList.add('hidden');
            form.querySelector('#taxi-dog-details-container').classList.add('hidden');

            const banhoCheckbox = form.querySelector('#service-banho');
            if (banhoCheckbox) {
                banhoCheckbox.disabled = false;
            }
            
            // CORRIGIDO: Reseta completamente o estado do calendário para o mês atual
            calendarState.selectedDates.clear();
            const today = new Date();
            calendarState.currentMonth = today.getMonth();
            calendarState.currentYear = today.getFullYear();

            const packageSummary = form.querySelector('#selected-dates-summary-package');
            if (packageSummary) {
                packageSummary.innerHTML = '';
            }
            const packageCalendar = form.querySelector('#calendar-for-package');
            if (packageCalendar) {
                packageCalendar.innerHTML = ''; 
            }
            
            form.querySelector('#editing-appointment-id').value = '';
        }
        
        function handleReplicateAppointment(id) {
            const appointmentToReplicate = allAppointments.find(app => app.id === id);
            if (!appointmentToReplicate) {
                showFeedback("Agendamento não encontrado para replicar.", "error");
                return;
            }

            const form = document.getElementById('appointment-form');
            resetFormState(); // Limpa o formulário primeiro

            // Preenche os dados
            form.querySelector('#tutor-name').value = appointmentToReplicate.tutorName || '';
            form.querySelector('#pet-name').value = appointmentToReplicate.petName || '';
            form.querySelector('#pet-breed').value = appointmentToReplicate.petBreed || '';
            form.querySelector('#observations').value = appointmentToReplicate.observations || '';

            // Limpa o campo de data/hora
            form.querySelector('#appointment-datetime').value = '';

            // Seleciona os serviços
            const allServices = appointmentToReplicate.services || [];
            form.querySelectorAll('#services-checkboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = allServices.includes(cb.value);
                cb.dispatchEvent(new Event('change', { bubbles: true }));
            });
            
            if (allServices.includes('Remoção')) {
                form.querySelectorAll('#remocao-sub-services input[type="checkbox"]').forEach(subCb => {
                    subCb.checked = allServices.includes(`Remoção de ${subCb.value}`);
                });
            }

            showFeedback("Dados replicados! Defina uma nova data e hora.", "success");
            
            // Mostra a barra lateral se estiver oculta e foca no campo de data
            document.getElementById('appointment-aside').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            form.querySelector('#appointment-datetime').focus();
        }

        function handleCardActions(e) {
            const target = e.target;
            
            // Handle remessa-level actions first, as they are not inside a card
            if (target.matches('.edit-remessa-btn')) {
                startEditRemessaMode(target.dataset.remessaId, target.dataset.remessaName);
                return;
            }
            if (target.matches('.undo-remessa-btn')) {
                handleUndoRemessa(target.dataset.remessaId);
                return;
            }
            if (target.matches('.finalize-remessa-btn')) {
                openFinalizeModal(null, target.dataset.remessaId);
                return;
            }

            // Then handle card-level actions
            const card = target.closest('.card-servico');
            if (!card) return;
            
            const appointmentId = card.dataset.id;
            
            if (isRemessaModeActive && activeTabId === 'grooming-tab-content' && !target.closest('button')) {
                toggleRemessaSelection(appointmentId);
                return;
            }

            if (card.classList.contains('compact-card') && !target.closest('button')) {
                card.classList.toggle('expanded');
                card.querySelector('.full-details').classList.toggle('hidden');
                card.querySelector('.compact-summary').classList.toggle('hidden');
                return;
            }

            if (target.matches('.delete-btn')) openConfirmationModal(appointmentId);
            else if (target.matches('.checkin-btn')) handleCheckIn(appointmentId);
            else if (target.matches('.finalize-btn')) openFinalizeModal(appointmentId);
            else if (target.matches('.revert-finalize-btn')) handleRevertFinalization(appointmentId);
            else if (target.matches('.edit-btn')) openEditModal(appointmentId);
            else if (target.matches('.request-service-btn')) openServiceRequestModal(appointmentId);
            else if (target.matches('.edit-package-dates-btn')) openEditPackageDatesModal(appointmentId);
            else if (target.matches('.approve-request-btn')) handleServiceRequestResponse(appointmentId, true);
            else if (target.matches('.deny-request-btn')) handleServiceRequestResponse(appointmentId, false);
            else if (target.matches('.discharge-btn')) handleDischarge(appointmentId);
            else if (target.matches('.notify-btn')) handleNotifyClient(appointmentId);
            else if (target.matches('.replicate-btn')) handleReplicateAppointment(appointmentId);
        }

        function openConfirmationModal(id, type = 'appointment') {
            const modal = document.getElementById('confirmation-modal');
            const confirmBtn = modal.querySelector('#confirm-delete-btn');
            const cancelBtn = modal.querySelector('#cancel-delete-btn');
            confirmBtn.dataset.id = id;
            confirmBtn.dataset.type = type;

            const enterListener = (e) => {
                if (e.key === 'Enter' && !modal.classList.contains('hidden')) {
                    e.preventDefault();
                    confirmBtn.click();
                }
            };
            
            const cleanup = () => {
                window.removeEventListener('keydown', enterListener);
            };

            confirmBtn.onclick = () => {
                if (type === 'remocao') deleteRemocao(id);
                else if (type === 'remessa_undo') undoRemessaAction(id);
                else deleteAppointment(id);
                modal.classList.add('hidden');
                cleanup();
            };
            
            cancelBtn.onclick = () => {
                modal.classList.add('hidden');
                cleanup();
            };

            window.addEventListener('keydown', enterListener);
            modal.classList.remove('hidden');
        }

        async function deleteAppointment(id) { try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id)); showFeedback("Excluído com sucesso."); } catch (e) { showFeedback(`Erro: ${e.message}`, "error"); } }
        async function deleteRemocao(id) { try { await deleteDoc(doc(db, `artifacts/${appId}/public/data/removals`, id)); showFeedback("Registo de remoção excluído."); } catch (e) { showFeedback(`Erro ao excluir: ${e.message}`, "error"); } }

        function handleUndoRemessa(remessaId) {
            openConfirmationModal(remessaId, 'remessa_undo');
        }

        // MODIFICADO: A função agora também limpa a ordem da remessa.
        async function undoRemessaAction(remessaId) {
            const appointmentsToUpdate = allAppointments.filter(app => app.remessaId === remessaId);

            if (appointmentsToUpdate.length === 0) {
                showFeedback("Nenhum agendamento encontrado para esta remessa.", "info");
                return;
            }
            
            const batch = writeBatch(db);
            appointmentsToUpdate.forEach(app => {
                const docRef = doc(db, `artifacts/${appId}/public/data/appointments`, app.id);
                batch.update(docRef, {
                    remessaId: null,
                    remessaName: null,
                    remessaCreatedAt: null,
                    remessaColor: null,
                    remessaOrder: null // Limpa o campo de ordem
                });
            });

            try {
                await batch.commit();
                showFeedback("Remessa desfeita com sucesso!");
            } catch (error) {
                showFeedback("Erro ao desfazer a remessa.", "error");
                console.error("Error undoing remessa: ", error);
            }
        }


        async function handleCheckIn(id) { try { await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { status: 'Chegou', checkinTime: serverTimestamp() }); showFeedback("Check-in realizado."); } catch (e) { showFeedback(`Erro: ${e.message}`, "error"); } }
        
        function openFinalizeModal(appointmentId, remessaId = null) {
            const modal = document.getElementById('finalize-modal');
            const confirmBtn = modal.querySelector('#confirm-finalize-btn');
            
            // Limpa os data-attributes anteriores
            delete confirmBtn.dataset.appointmentId;
            delete confirmBtn.dataset.remessaId;

            if (appointmentId) {
                confirmBtn.dataset.appointmentId = appointmentId;
            }
            if (remessaId) {
                confirmBtn.dataset.remessaId = remessaId;
            }

            const input = modal.querySelector('#finalize-handler-input');
            input.value = '';
            modal.classList.remove('hidden');
            input.focus();
        }

        async function handleFinalize(appointmentId, handlerId) {
            try {
                await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, appointmentId), { 
                    status: 'Finalizado', 
                    finalizedAt: serverTimestamp(),
                    finalizedBy: handlerId 
                });
                showFeedback("Serviço finalizado com sucesso.");
            } catch (e) {
                showFeedback(`Erro ao finalizar: ${e.message}`, "error");
            }
        }

        async function handleBatchFinalize(remessaId, handlerId) {
            const batch = writeBatch(db);
            const appointmentsToUpdate = allAppointments.filter(app => app.remessaId === remessaId && app.status !== 'Finalizado');

            if (appointmentsToUpdate.length === 0) {
                showFeedback("Todos os pets nesta remessa já estão finalizados.", "info");
                return;
            }

            appointmentsToUpdate.forEach(app => {
                const docRef = doc(db, `artifacts/${appId}/public/data/appointments`, app.id);
                batch.update(docRef, {
                    status: 'Finalizado',
                    finalizedAt: serverTimestamp(),
                    finalizedBy: handlerId
                });
            });

            try {
                await batch.commit();
                showFeedback(`Remessa finalizada com sucesso por ${handlerId}.`);
            } catch (error) {
                showFeedback(`Erro ao finalizar remessa: ${error.message}`, "error");
            }
        }
        
        async function handleRevertFinalization(id) { try { await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { status: 'Chegou', finalizedAt: null, finalizedBy: null }); showFeedback("Status revertido para 'Chegou'."); } catch (e) { showFeedback(`Erro ao reverter: ${e.message}`, "error"); } }
        async function handleDischarge(id) { try { await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { isDischarged: true }); showFeedback("Baixa realizada com sucesso."); } catch (e) { showFeedback(`Erro ao dar baixa: ${e.message}`, "error"); } }
        async function handleNotifyClient(id) { try { await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { notifiedAt: serverTimestamp() }); showFeedback("Cliente notificado."); } catch (e) { showFeedback(`Erro ao notificar: ${e.message}`, "error"); } }
        
        function openEditModal(id) {
            const appointment = allAppointments.find(app => app.id === id); if (!appointment) return;
            const modalContent = document.getElementById('edit-modal-content');
            const formClone = document.getElementById('appointment-form').cloneNode(true);
            formClone.id = 'edit-form'; modalContent.innerHTML = ''; modalContent.appendChild(formClone);
            formClone.querySelector('h2')?.remove(); formClone.querySelector('button[type="submit"]').textContent = 'Guardar Alterações';
            populateFormForEditing(formClone, appointment);
            const cancelButton = document.createElement('button');
            cancelButton.type = 'button'; cancelButton.textContent = 'Cancelar'; cancelButton.className = 'w-full mt-2 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg';
            cancelButton.onclick = () => document.getElementById('edit-appointment-modal').classList.add('hidden');
            formClone.appendChild(cancelButton);
            formClone.addEventListener('submit', handleFormSubmit);
            document.getElementById('edit-appointment-modal').classList.remove('hidden');
        }

        function populateFormForEditing(form, data) {
            form.querySelector('#editing-appointment-id').value = data.id; form.querySelector('#tutor-name').value = data.tutorName;
            form.querySelector('#pet-name').value = data.petName; form.querySelector('#pet-breed').value = data.petBreed;
            const dt = new Date(data.appointmentDatetime); dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
            form.querySelector('#appointment-datetime').value = dt.toISOString().slice(0, 16);
            form.querySelectorAll('[id^="service-"]').forEach(cb => {
                cb.checked = data.services.some(s => s.startsWith(cb.value));
                ['pacote', 'remocao', 'taxi'].forEach(type => { if (cb.id.includes(type)) cb.dispatchEvent(new Event('change', { bubbles: true }))});
            });
            if (data.services.includes('Remoção')) form.querySelectorAll('[id^="sub-service-"]').forEach(cb => { cb.checked = data.services.includes(`Remoção de ${cb.value}`); });
            if (data.services.includes('Taxi Dog')) { form.querySelector('#pickup-time').value = data.pickupTime || ''; form.querySelector('#return-time').value = data.returnTime || ''; form.querySelector('#client-route').value = data.clientRoute || ''; }
            if (data.services.includes('Pacote de Banho')) { calendarState.selectedDates = new Set((data.bathPackageDates || []).map(d => new Date(d).toISOString().split('T')[0])); renderCalendar('calendar-for-package', calendarState, form); }
            form.querySelector('#observations').value = data.observations || '';
        }
        
        function openServiceRequestModal(id) {
            const modal = document.getElementById('service-request-modal');
            const container = document.getElementById('service-request-container');
            container.innerHTML = document.getElementById('main-form-services-wrapper').cloneNode(true).innerHTML;
            container.querySelectorAll('[id^="service-"]').forEach(cb => {
                cb.checked = false; 
                if (cb.id.includes('pacote')) cb.parentElement.remove();
            });
            modal.querySelector('#service-request-observations').value = '';
            modal.querySelector('#send-service-request-btn').dataset.id = id;
            modal.classList.remove('hidden');
        }

        async function handleSendServiceRequest(e) {
            e.preventDefault();
            const form = e.target, button = form.querySelector('button[type="submit"]'), id = button.dataset.id;
            const currentAppointment = allAppointments.find(app => app.id === id);
            if (!currentAppointment) return;

            button.disabled = true; button.textContent = 'A enviar...';
            try {
                const requestedAdditions = Array.from(form.querySelectorAll('[id^="service-"]:checked')).map(cb => cb.value);
                if (requestedAdditions.includes('Remoção')) {
                    requestedAdditions.push(...Array.from(form.querySelectorAll('[id^="sub-service-"]:checked')).map(cb => `Remoção de ${cb.value}`));
                }
                const finalServiceList = [...new Set([...currentAppointment.services, ...requestedAdditions])];
                const serviceRequest = {
                    requestedAdditions,
                    finalServiceList,
                    newObservations: form.querySelector('#service-request-observations').value, 
                    status: 'Pending', 
                    requestedAt: serverTimestamp()
                };
                await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { serviceRequest });
                showFeedback("Solicitação de serviço enviada!");
                document.getElementById('service-request-modal').classList.add('hidden');
            } catch (error) {
                showFeedback(`Erro ao enviar solicitação: ${error.message}`, "error");
            } finally {
                button.disabled = false; button.textContent = 'Enviar Solicitação';
            }
        }

        async function handleServiceRequestResponse(id, isApproved) {
            const appointment = allAppointments.find(app => app.id === id);
            if (!appointment || !appointment.serviceRequest) return;
            try {
                const updateData = {
                    'serviceRequest.status': isApproved ? 'Approved' : 'Denied',
                    'serviceRequest.respondedAt': serverTimestamp()
                };
                if (isApproved) {
                    updateData.services = appointment.serviceRequest.finalServiceList;
                    updateData.observations = appointment.serviceRequest.newObservations;
                }
                await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), updateData);
                showFeedback(`Solicitação ${isApproved ? 'aprovada' : 'negada'}!`);
            } catch (error) {
                showFeedback(`Erro ao responder à solicitação: ${error.message}`, "error");
            }
        }
        
        function renderCalendar(containerId, state, context) {
            const container = context.querySelector(`#${containerId}`); if (!container) return;
            const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"], daysOfWeek = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
            const firstDay = new Date(state.currentYear, state.currentMonth, 1).getDay(), daysInMonth = new Date(state.currentYear, state.currentMonth + 1, 0).getDate();
            let html = `<div class="flex justify-between items-center mb-2 text-white"><button type="button" class="prev-month-btn p-1">&lt;</button><span class="font-bold">${monthNames[state.currentMonth]} ${state.currentYear}</span><button type="button" class="next-month-btn p-1">&gt;</button></div><div class="grid grid-cols-7 text-center text-xs font-medium text-gray-300">${daysOfWeek.map(d=>`<div>${d}</div>`).join('')}</div><div class="grid grid-cols-7 text-center text-sm gap-1 mt-2">`;
            html += '<div></div>'.repeat(firstDay);
            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${state.currentYear}-${String(state.currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                html += `<div class="calendar-day p-1 cursor-pointer ${state.selectedDates.has(dateStr)?'selected':''}" data-date="${dateStr}">${i}</div>`;
            }
            container.innerHTML = html + '</div>';
            updateSelectedDatesSummary(containerId, state, context);
            container.querySelector('.prev-month-btn').onclick = () => changeMonth(-1, containerId, state, context);
            container.querySelector('.next-month-btn').onclick = () => changeMonth(1, containerId, state, context);
            container.querySelectorAll('.calendar-day').forEach(d => d.onclick = () => toggleDateSelection(d.dataset.date, containerId, state, context));
        }
        
        function changeMonth(dir, id, state, context) { state.currentMonth += dir; if(state.currentMonth<0){state.currentMonth=11;state.currentYear--}else if(state.currentMonth>11){state.currentMonth=0;state.currentYear++} renderCalendar(id, state, context); }
        
        function toggleDateSelection(date, id, state, context) { if(!date)return; state.selectedDates.has(date)?state.selectedDates.delete(date):state.selectedDates.add(date); renderCalendar(id, state, context); }
        
        function updateSelectedDatesSummary(containerId, state, context) {
            const summaryId = containerId === 'calendar-for-package' ? 'selected-dates-summary-package' : 'selected-dates-summary-editing';
            const summaryEl = context.querySelector(`#${summaryId}`);
            if (summaryEl) summaryEl.textContent = state.selectedDates.size > 0 ? `Datas: ${Array.from(state.selectedDates).sort().map(d=>new Date(d+'T12:00').toLocaleDateString('pt-BR')).join(', ')}` : '';
        }
        
        function openEditPackageDatesModal(id) {
            const app = allAppointments.find(a => a.id === id); if (!app) return;
            const modal = document.getElementById('edit-package-dates-only-modal');
            modal.querySelector('#edit-dates-appointment-id').value = id;
            editCalendarState.selectedDates = new Set((app.bathPackageDates || []).map(d => new Date(d).toISOString().split('T')[0]));
            const appDate = new Date(app.appointmentDatetime); editCalendarState.currentMonth = appDate.getMonth(); editCalendarState.currentYear = appDate.getFullYear();
            renderCalendar('calendar-for-editing', editCalendarState, modal);
            modal.classList.remove('hidden');
        }
        
        async function handleSavePackageDatesOnly() {
            const id = document.getElementById('edit-dates-appointment-id').value, btn = document.getElementById('save-package-dates-btn');
            btn.disabled = true; btn.textContent = 'A guardar...';
            try {
                const newDates = Array.from(editCalendarState.selectedDates).map(d => Timestamp.fromDate(new Date(d+'T12:00')));
                await updateDoc(doc(db, `artifacts/${appId}/public/data/appointments`, id), { bathPackageDates: newDates });
                showFeedback("Datas do pacote atualizadas!");
                document.getElementById('edit-package-dates-only-modal').classList.add('hidden');
            } catch(e) { showFeedback(`Erro: ${e.message}`, "error"); } finally { btn.disabled = false; btn.textContent = 'Guardar Datas'; }
        }
        
        function updateViewToggleButtons(activeTab) {
            if (!activeTab || activeTab === 'history') return;

            const currentView = viewModes[activeTab];
            document.querySelectorAll(`.view-toggle-btn[data-tab="${activeTab}"]`).forEach(button => {
                const isSelected = button.dataset.view === currentView;
                button.classList.toggle('bg-teal-500', isSelected);
                button.classList.toggle('text-white', isSelected);
                button.classList.toggle('bg-gray-200', !isSelected);
                button.classList.toggle('text-gray-600', !isSelected);
            });
        }
        
        // MODIFICADO: Função de população de filtros dinâmica
        function populateServiceFilters() {
            const allServices = new Set();
            allAppointments.forEach(app => {
                (app.services || []).forEach(service => {
                    if (!service.startsWith('Remoção de ')) {
                        allServices.add(service);
                    }
                });
            });
            const uniqueServiceNames = [...allServices].sort();

            const populate = (filter, currentVal) => {
                if (filter) {
                    filter.innerHTML = '<option value="">Todos os Serviços</option>';
                    uniqueServiceNames.forEach(name => {
                        filter.innerHTML += `<option value="${name}">${name}</option>`;
                    });
                    filter.value = currentVal;
                }
            };
            
            const receptionFilter = document.getElementById('reception-service-filter');
            const groomingFilter = document.getElementById('grooming-service-filter');
            
            populate(receptionFilter, receptionFilter ? receptionFilter.value : "");
            populate(groomingFilter, groomingFilter ? groomingFilter.value : "");
        }

        function setupVirtualKeyboard() {
            let activeInputElement = null;
            let capsLock = false;
            const keyboardContainer = document.getElementById('virtual-keyboard-container');
            const keyboard = document.getElementById('virtual-keyboard');
            
            const keysLayout = [
                ["1", "2", "3", "4", "5", "6", "7", "8", "9", "0"],
                ["q", "w", "e", "r", "t", "y", "u", "i", "o", "p"],
                ["a", "s", "d", "f", "g", "h", "j", "k", "l", "ç"],
                ["caps", "z", "x", "c", "v", "b", "n", "m", "backspace"],
                ["space"]
            ];
            
            function createKeys() {
                keyboard.innerHTML = '';
                keyboard.className = 'space-y-1';
                keysLayout.forEach(row => {
                    const rowDiv = document.createElement('div');
                    rowDiv.className = 'flex justify-center gap-1';
                    row.forEach(key => {
                        const keyElement = document.createElement('button');
                        keyElement.type = 'button';
                        keyElement.className = 'keyboard-key py-2 px-3 bg-white rounded-md shadow-sm font-semibold flex items-center justify-center border border-gray-300 flex-grow';
                        keyElement.setAttribute('data-key', key);

                        switch(key) {
                            case "backspace":
                                keyElement.innerHTML = '&#9003;';
                                keyElement.classList.add('flex-grow-[1.5]');
                                break;
                            case "caps":
                                keyElement.innerHTML = 'Caps';
                                keyElement.classList.add('flex-grow-[1.5]');
                                if(capsLock) keyElement.classList.add('active-special');
                                break;
                            case "space":
                                keyElement.innerHTML = ' ';
                                keyElement.classList.add('flex-grow-[8]');
                                break;
                            default:
                                keyElement.textContent = capsLock ? key.toUpperCase() : key.toLowerCase();
                                break;
                        }
                        rowDiv.appendChild(keyElement);
                    });
                    keyboard.appendChild(rowDiv);
                });
            }

            createKeys();
            
            document.addEventListener('focusin', (e) => {
                if(e.target.matches('input[type="text"], input[type="time"], input[type="datetime-local"], textarea, input[type="date"], input[type="month"]')) {
                    activeInputElement = e.target;
                    keyboardContainer.classList.remove('translate-y-full');
                }
            });

            document.addEventListener('focusout', (e) => {
                setTimeout(() => {
                    if (!document.activeElement.closest('#virtual-keyboard-container')) {
                         keyboardContainer.classList.add('translate-y-full');
                         activeInputElement = null;
                    }
                }, 100);
            });

            keyboard.addEventListener('click', (e) => {
                if(!activeInputElement) return;
                
                const key = e.target.closest('.keyboard-key')?.dataset.key;
                if (!key) return;

                switch(key) {
                    case "backspace":
                        activeInputElement.value = activeInputElement.value.slice(0, -1);
                        break;
                    case "caps":
                        capsLock = !capsLock;
                        createKeys();
                        break;
                    case "space":
                        activeInputElement.value += ' ';
                        break;
                    default:
                        activeInputElement.value += capsLock ? key.toUpperCase() : key.toLowerCase();
                        break;
                }
                activeInputElement.focus();
            });
            
            keyboardContainer.addEventListener('mousedown', (e) => {
                e.preventDefault();
            });
        }
        
        // --- FUNÇÕES DO CALENDÁRIO E RELÓGIO ---

        function updateClock() {
            const clockElement = document.getElementById('digital-clock');
            if (clockElement) {
                const now = new Date();
                const timeString = now.toLocaleTimeString('pt-BR');
                clockElement.textContent = timeString;
            }
        }

        function openFilterCalendar(filterId) {
            filterCalendarState.activeFilterId = filterId;
            const targetButton = document.getElementById(filterId);
            const currentDate = new Date(targetButton.dataset.date + 'T12:00:00');
            
            filterCalendarState.currentMonth = currentDate.getMonth();
            filterCalendarState.currentYear = currentDate.getFullYear();

            renderFilterCalendar(filterId);
            document.getElementById('calendar-modal').classList.remove('hidden');
        }

        function renderFilterCalendar() {
            const { currentMonth, currentYear, activeFilterId } = filterCalendarState;
            const container = document.getElementById('calendar-modal-content');
            const targetButton = document.getElementById(activeFilterId);
            const selectedDate = targetButton.dataset.date;
            
            const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const daysOfWeek = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
            
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            let html = `<div class="w-80"><div class="flex justify-between items-center mb-4"><button type="button" id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">&lt;</button><span class="font-bold text-lg">${monthNames[currentMonth]} ${currentYear}</span><button type="button" id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">&gt;</button></div><div class="grid grid-cols-7 text-center text-sm font-medium text-gray-500">${daysOfWeek.map(d => `<div>${d}</div>`).join('')}</div><div class="grid grid-cols-7 text-center text-sm gap-1 mt-2">`;
            
            html += '<div></div>'.repeat(firstDayOfMonth);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const isSelected = dateStr === selectedDate;
                html += `<div class="p-2 cursor-pointer rounded-full hover:bg-teal-100 ${isSelected ? 'bg-teal-500 text-white font-bold' : ''}" data-date="${dateStr}">${i}</div>`;
            }
            
            container.innerHTML = html + '</div></div>';

            container.querySelectorAll('[data-date]').forEach(dayCell => {
                dayCell.addEventListener('click', () => {
                    const newDate = dayCell.dataset.date;
                    const dateObj = new Date(newDate + 'T12:00:00');
                    targetButton.dataset.date = newDate;
                    targetButton.textContent = dateObj.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    document.getElementById('calendar-modal').classList.add('hidden');
                    if (activeFilterId.startsWith('remocao-')) {
                        renderRemocaoHistory();
                    } else {
                        renderAllContent();
                    }
                });
            });

            document.getElementById('prev-month-btn').addEventListener('click', () => {
                filterCalendarState.currentMonth--;
                if (filterCalendarState.currentMonth < 0) {
                    filterCalendarState.currentMonth = 11;
                    filterCalendarState.currentYear--;
                }
                renderFilterCalendar();
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                filterCalendarState.currentMonth++;
                if (filterCalendarState.currentMonth > 11) {
                    filterCalendarState.currentMonth = 0;
                    filterCalendarState.currentYear++;
                }
                renderFilterCalendar();
            });
        }
    </script>

</body>
</html>
